<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kyest.cl BI Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<style>
:root{
  --bg:#0C1117;--surface:#131920;--surface2:#1A2332;--border:#263348;
  --accent:#3478F6;--accent-light:rgba(52,120,246,0.12);
  --teal:#0D9488;--teal-light:rgba(13,148,136,0.12);
  --amber:#D97706;--amber-light:rgba(217,119,6,0.12);
  --red:#DC2626;--red-light:rgba(220,38,38,0.12);
  --purple:#7C3AED;--purple-light:rgba(124,58,237,0.12);
  --text:#E2E8F0;--text2:#8B9BB4;--text3:#526072;
  --sidebar:220px;--header:56px;
  --radius:10px;--radius-sm:6px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:14px;display:flex;min-height:100vh;}
a{color:inherit;text-decoration:none;}

/* SIDEBAR */
#sidebar{width:var(--sidebar);min-height:100vh;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:200;transition:width .25s;}
#sidebar.collapsed{width:52px;}
#sidebar.collapsed .nav-label,.sidebar-logo-text{display:none;}
#sidebar.collapsed #sidebar{width:52px;}
.sidebar-header{height:var(--header);display:flex;align-items:center;padding:0 14px;border-bottom:1px solid var(--border);gap:10px;overflow:hidden;}
.sidebar-logo{width:28px;height:28px;background:var(--accent);border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:#fff;flex-shrink:0;}
.sidebar-logo-text{font-weight:700;font-size:15px;white-space:nowrap;}
nav{flex:1;padding:10px 0;}
nav a{display:flex;align-items:center;gap:11px;padding:9px 14px;cursor:pointer;border-radius:0;transition:background .15s;white-space:nowrap;overflow:hidden;color:var(--text2);font-size:13.5px;}
nav a:hover{background:var(--surface2);color:var(--text);}
nav a.active{background:var(--accent-light);color:var(--accent);border-right:2px solid var(--accent);}
nav a .nav-icon{font-size:17px;flex-shrink:0;width:24px;text-align:center;}
.sidebar-toggle{margin:10px;padding:8px;border-radius:var(--radius-sm);background:var(--surface2);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:16px;text-align:center;}
.sidebar-toggle:hover{background:var(--border);color:var(--text);}

/* HEADER */
#header{position:fixed;top:0;left:var(--sidebar);right:0;height:var(--header);background:var(--surface);border-bottom:1px solid var(--border);z-index:100;display:flex;align-items:center;padding:0 20px;gap:12px;transition:left .25s;}
#header.collapsed{left:52px;}
.header-title{font-weight:700;font-size:16px;flex:1;}
.date-presets{display:flex;gap:6px;}
.preset-btn{padding:5px 11px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-size:12px;transition:all .15s;}
.preset-btn:hover,.preset-btn.active{background:var(--accent-light);color:var(--accent);border-color:var(--accent);}
.date-input{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:var(--radius-sm);font-size:13px;width:200px;}
.date-input:focus{outline:none;border-color:var(--accent);}
.hamburger{display:none;background:none;border:none;color:var(--text);font-size:22px;cursor:pointer;}

/* MAIN */
#main{margin-left:var(--sidebar);margin-top:var(--header);flex:1;padding:24px;transition:margin-left .25s;}
#main.collapsed{margin-left:52px;}

/* SECTION */
.section{display:none;}
.section.active{display:block;}
.section-title{font-size:20px;font-weight:700;margin-bottom:6px;}
.section-sub{color:var(--text2);font-size:13px;margin-bottom:20px;}

/* KPI GRID */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px;margin-bottom:22px;}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;position:relative;overflow:hidden;}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);}
.kpi-card.teal::before{background:var(--teal);}
.kpi-card.amber::before{background:var(--amber);}
.kpi-card.red::before{background:var(--red);}
.kpi-card.purple::before{background:var(--purple);}
.kpi-label{font-size:11.5px;color:var(--text2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;}
.kpi-value{font-size:26px;font-weight:700;line-height:1.1;}
.kpi-sub{font-size:11.5px;color:var(--text3);margin-top:5px;}
.kpi-badge{display:inline-block;padding:2px 7px;border-radius:12px;font-size:11px;font-weight:600;margin-top:6px;}
.badge-green{background:var(--teal-light);color:var(--teal);}
.badge-yellow{background:var(--amber-light);color:var(--amber);}
.badge-red{background:var(--red-light);color:var(--red);}
.badge-blue{background:var(--accent-light);color:var(--accent);}
.badge-purple{background:var(--purple-light);color:var(--purple);}

/* ROAS CARD */
.roas-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px 24px;margin-bottom:22px;display:flex;align-items:center;gap:24px;}
.roas-big{font-size:48px;font-weight:800;line-height:1;}
.roas-big.green{color:var(--teal);}
.roas-big.yellow{color:var(--amber);}
.roas-big.red{color:var(--red);}
.roas-info .roas-label{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px;}
.roas-info .roas-sub{font-size:14px;color:var(--text2);margin-top:6px;}
.roas-divider{width:1px;height:50px;background:var(--border);}

/* CHARTS */
.charts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:16px;margin-bottom:22px;}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;}
.chart-card.wide{grid-column:1/-1;}
.chart-title{font-size:14px;font-weight:600;margin-bottom:14px;color:var(--text);}
.chart-wrap{position:relative;height:220px;}
.chart-wrap.tall{height:280px;}

/* TABLES */
.table-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:22px;}
.table-header{padding:14px 18px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);}
.table-header-title{font-weight:600;flex:1;}
.table-search{padding:6px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;width:220px;}
.table-search:focus{outline:none;border-color:var(--accent);}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead th{background:var(--surface2);padding:10px 14px;text-align:left;font-weight:600;color:var(--text2);white-space:nowrap;cursor:pointer;user-select:none;border-bottom:1px solid var(--border);}
thead th:hover{color:var(--text);}
thead th .sort-icon{opacity:.4;font-size:10px;margin-left:4px;}
thead th.sorted .sort-icon{opacity:1;color:var(--accent);}
tbody tr{border-bottom:1px solid rgba(38,51,72,.5);}
tbody tr:hover{background:rgba(52,120,246,.04);}
tbody td{padding:9px 14px;vertical-align:middle;white-space:nowrap;}
.td-name{max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.td-bold{font-weight:600;}
.ctr-red{color:var(--red);}
.ctr-yellow{color:var(--amber);}
.ctr-green{color:var(--teal);}
.status-badge{padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;}
.status-active{background:var(--teal-light);color:var(--teal);}
.status-paused{background:var(--surface2);color:var(--text3);}

/* INSIGHTS */
.insights-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;margin-bottom:22px;}
.insight-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;}
.insight-card.critical{border-color:rgba(220,38,38,.4);background:rgba(220,38,38,.04);}
.insight-card.positive{border-color:rgba(13,148,136,.4);background:rgba(13,148,136,.04);}
.insight-card.info{border-color:rgba(52,120,246,.4);background:rgba(52,120,246,.04);}
.insight-icon{font-size:22px;margin-bottom:8px;}
.insight-title{font-weight:700;font-size:14px;margin-bottom:8px;}
.insight-text{color:var(--text2);font-size:13px;line-height:1.6;}

/* TABS */
.tabs{display:flex;gap:4px;margin-bottom:18px;background:var(--surface2);padding:4px;border-radius:var(--radius-sm);width:fit-content;}
.tab-btn{padding:7px 18px;border-radius:var(--radius-sm);border:none;background:transparent;color:var(--text2);cursor:pointer;font-size:13px;transition:all .15s;}
.tab-btn.active{background:var(--accent);color:#fff;}
.tab-btn:hover:not(.active){background:var(--border);color:var(--text);}
.tab-content{display:none;}
.tab-content.active{display:block;}

/* EXPORT BTN */
.export-btn{padding:6px 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px;transition:all .15s;}
.export-btn:hover{border-color:var(--accent);color:var(--accent);}

/* PROGRESS BAR */
.progress-bar-wrap{background:var(--surface2);border-radius:4px;height:6px;overflow:hidden;margin-top:4px;}
.progress-bar-fill{height:100%;border-radius:4px;background:var(--accent);}

/* RETENTION TABLE */
.retention-table{width:100%;border-collapse:collapse;}
.retention-table th,.retention-table td{padding:10px 16px;text-align:left;border-bottom:1px solid var(--border);}
.retention-table th{color:var(--text2);font-size:12px;text-transform:uppercase;}


/* ANIMATED NUMBERS */
@keyframes countUp {from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.kpi-value{animation:countUp .4s ease-out;}
/* TOOLTIP */
.tooltip-wrap{position:relative;display:inline-block;}
.tooltip-wrap .tt{visibility:hidden;background:var(--surface2);color:var(--text);font-size:12px;padding:6px 10px;border-radius:6px;border:1px solid var(--border);position:absolute;bottom:125%;left:50%;transform:translateX(-50%);white-space:nowrap;z-index:999;pointer-events:none;opacity:0;transition:opacity .2s;}
.tooltip-wrap:hover .tt{visibility:visible;opacity:1;}
/* SCROLLBAR */
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--text3);}
/* METRIC COMPARISON */
.compare-row{display:flex;align-items:center;gap:8px;margin-top:8px;}
.compare-bar{flex:1;height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;}
.compare-fill{height:100%;border-radius:2px;transition:width .6s ease;}
/* ALERT BANNER */
.alert-banner{padding:12px 18px;border-radius:var(--radius);margin-bottom:16px;display:flex;align-items:center;gap:12px;font-size:13px;}
.alert-banner.warning{background:var(--amber-light);border:1px solid rgba(217,119,6,.3);color:var(--amber);}
.alert-banner.success{background:var(--teal-light);border:1px solid rgba(13,148,136,.3);color:var(--teal);}
.alert-banner.info{background:var(--accent-light);border:1px solid rgba(52,120,246,.3);color:var(--accent);}
/* MINI SPARKLINE */
.sparkline-wrap{height:32px;margin-top:6px;}
/* FOOTER */
#dashboard-footer{margin-top:32px;padding:20px 0;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;color:var(--text3);font-size:12px;}
/* LOADING SKELETON */
@keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
.skeleton{background:linear-gradient(90deg,var(--surface2) 25%,var(--border) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:4px;height:20px;}
/* DATA FRESHNESS */
.data-fresh{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:12px;background:var(--teal-light);color:var(--teal);font-size:11px;}
.data-fresh::before{content:'‚óè';font-size:8px;}
/* NUMBER HIGHLIGHT */
.num-highlight{font-variant-numeric:tabular-nums;}
/* GRID RESPONSIVE ADDITIONS */
@media(max-width:600px){.kpi-grid{grid-template-columns:1fr!important;}.roas-card{flex-direction:column;}.roas-divider{width:100%;height:1px;}.roas-big{font-size:36px;}}
/* CAMPAIGN STATUS */
.obj-badge{display:inline-block;padding:2px 7px;border-radius:10px;font-size:10.5px;font-weight:600;letter-spacing:.03em;}
.obj-leads{background:var(--purple-light);color:var(--purple);}
.obj-engagement{background:var(--accent-light);color:var(--accent);}
.obj-sales{background:var(--teal-light);color:var(--teal);}
.obj-traffic{background:var(--amber-light);color:var(--amber);}
/* PROGRESS INDICATOR */
.section-progress{height:2px;background:var(--accent);position:fixed;top:var(--header);left:var(--sidebar);right:0;transform:scaleX(0);transform-origin:left;transition:transform .3s,left .25s;}
.section-progress.collapsed{left:52px;}
/* CARD HOVER EFFECT */
.kpi-card{transition:transform .15s,box-shadow .15s;}
.kpi-card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,.3);}
.chart-card{transition:box-shadow .15s;}
.chart-card:hover{box-shadow:0 4px 20px rgba(0,0,0,.2);}
/* PERFORMANCE SCORE */
.perf-score{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;border:3px solid;}
.perf-good{border-color:var(--teal);color:var(--teal);}
.perf-avg{border-color:var(--amber);color:var(--amber);}
.perf-bad{border-color:var(--red);color:var(--red);}

/* PRINT STYLES */
@media print {
  #sidebar, #header, .preset-btn, .export-btn, .date-input, .sidebar-toggle, #perf-banner { display: none !important; }
  #main { margin: 0 !important; padding: 16px !important; }
  body { background: white !important; color: black !important; }
  .kpi-card, .chart-card, .table-card { border: 1px solid #ddd !important; background: white !important; }
  .kpi-value { color: black !important; }
  .kpi-label, .kpi-sub { color: #666 !important; }
  .section { display: block !important; page-break-after: always; }
}
/* COMPARISON CARDS */
.comparison-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
}
.comparison-left, .comparison-right {
  flex: 1;
  text-align: center;
  padding: 12px;
  border-radius: var(--radius-sm);
}
.comparison-left { background: var(--amber-light); border: 1px solid rgba(217,119,6,.2); }
.comparison-right { background: var(--teal-light); border: 1px solid rgba(13,148,136,.2); }
.comparison-vs {
  font-weight: 800;
  font-size: 20px;
  color: var(--text3);
  padding: 0 8px;
}
/* METRIC CARDS HORIZONTAL */
.metric-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.metric-pill {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text2);
  display: flex;
  align-items: center;
  gap: 6px;
}
.metric-pill .pill-val { color: var(--text); }
/* SUMMARY HIGHLIGHT */
.summary-box {
  background: linear-gradient(135deg, rgba(52,120,246,0.08) 0%, rgba(13,148,136,0.08) 100%);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 24px;
  margin-bottom: 22px;
}
.summary-box-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text);
}
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
}
.summary-item { }
.summary-item-label { font-size: 11px; color: var(--text3); margin-bottom: 3px; }
.summary-item-value { font-size: 18px; font-weight: 700; }
/* TREND INDICATORS */
.trend-up::after { content: ' ‚Üë'; color: var(--teal); font-size: 12px; }
.trend-down::after { content: ' ‚Üì'; color: var(--red); font-size: 12px; }
.trend-flat::after { content: ' ‚Üí'; color: var(--amber); font-size: 12px; }
/* GA4 CHANNEL ICONS */
.ch-paid-social::before { content: 'üì± '; }
.ch-organic-search::before { content: 'üîç '; }
.ch-direct::before { content: 'üîó '; }
.ch-organic-social::before { content: 'üí¨ '; }
.ch-referral::before { content: '‚Üó '; }
/* HIGHLIGHT ROW */
tbody tr.highlight-row { background: rgba(52,120,246,0.06) !important; }
tbody tr.highlight-row td { font-weight: 600; }
/* FLATPICKR OVERRIDES */
.flatpickr-calendar{background:var(--surface)!important;border:1px solid var(--border)!important;color:var(--text)!important;}
.flatpickr-day{color:var(--text2)!important;}
.flatpickr-day.selected,.flatpickr-day.inRange{background:var(--accent)!important;border-color:var(--accent)!important;color:#fff!important;}

/* RESPONSIVE */
@media(max-width:768px){
  :root{--sidebar:0px;}
  #sidebar{transform:translateX(-220px);width:220px!important;}
  #sidebar.mobile-open{transform:translateX(0);}
  #header{left:0!important;}
  #main{margin-left:0!important;}
  .hamburger{display:block;}
  .kpi-grid{grid-template-columns:repeat(2,1fr);}
  .charts-grid{grid-template-columns:1fr;}
  .date-presets{display:none;}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">K</div>
    <span class="sidebar-logo-text">Kyest.cl BI</span>
  </div>
  <nav>
    <a class="active" onclick="showSection('overview',this)"><span class="nav-icon">üìä</span><span class="nav-label">Overview</span></a>
    <a onclick="showSection('meta',this)"><span class="nav-icon">üì£</span><span class="nav-label">Meta Ads</span></a>
    <a onclick="showSection('ads',this)"><span class="nav-icon">üëÅÔ∏è</span><span class="nav-label">Anuncios</span></a>
    <a onclick="showSection('shopify',this)"><span class="nav-icon">üõí</span><span class="nav-label">Shopify</span></a>
    <a onclick="showSection('clientes',this)"><span class="nav-icon">üë•</span><span class="nav-label">Clientes</span></a>
    <a onclick="showSection('analytics',this)"><span class="nav-icon">üìà</span><span class="nav-label">Analytics</span></a>
  </nav>
  <div class="sidebar-toggle" onclick="toggleSidebar()" title="Colapsar sidebar">‚ò∞</div>
</aside>

<!-- HEADER -->
<header id="header">
  <button class="hamburger" onclick="toggleMobile()">‚ò∞</button>
  <div class="header-title" id="headerTitle">Overview</div>
  <div class="date-presets">
    <button class="preset-btn" onclick="setPreset('today')">HOY</button>
    <button class="preset-btn" onclick="setPreset('7d')">7D</button>
    <button class="preset-btn" onclick="setPreset('30d')">30D</button>
    <button class="preset-btn" onclick="setPreset('3m')">3M</button>
    <button class="preset-btn" onclick="setPreset('6m')">6M</button>
    <button class="preset-btn active" onclick="setPreset('all')">TODO</button>
  </div>
  <input class="date-input" id="datePicker" type="text" placeholder="Seleccionar rango‚Ä¶" readonly/>
</header>

<!-- MAIN CONTENT -->
<main id="main">

  <!-- ===== OVERVIEW ===== -->
  <section class="section active" id="s-overview">
    <div class="section-title">üìä Overview General</div>
    <div class="section-sub" id="overview-period">Per√≠odo completo ¬∑ Kyest.cl</div>


    <!-- Summary highlight box -->
    <div class="summary-box" id="overview-summary">
      <div class="summary-box-title">üéØ Resumen Ejecutivo ‚Äî Kyest.cl</div>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-item-label">Revenue Total</div>
          <div class="summary-item-value" style="color:var(--teal)">$43.6M</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">Inversi√≥n Meta</div>
          <div class="summary-item-value" style="color:var(--amber)">$25.1M</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">ROAS Real</div>
          <div class="summary-item-value" style="color:var(--amber)">1.74x</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">Beneficio Neto</div>
          <div class="summary-item-value" style="color:var(--teal)">$18.5M</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">√ìrdenes</div>
          <div class="summary-item-value">250</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">Clientes √önicos</div>
          <div class="summary-item-value">203</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">Ticket Promedio</div>
          <div class="summary-item-value">$174K</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">Crecimiento MoM</div>
          <div class="summary-item-value" style="color:var(--teal)">+94%</div>
        </div>
      </div>
    </div>
    <div class="roas-card" id="overview-roas-card">
      <div>
        <div style="font-size:11.5px;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px;">ROAS Real</div>
        <div class="roas-big" id="ov-roas-val">1.74x</div>
        <div style="font-size:13px;color:var(--text2);margin-top:6px;" id="ov-roas-sub">250 √≥rdenes ¬∑ $174K promedio/venta</div>
      </div>
      <div class="roas-divider"></div>
      <div style="flex:1;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
        <div><div style="font-size:11px;color:var(--text3);margin-bottom:3px;">Revenue Shopify</div><div style="font-size:18px;font-weight:700;" id="ov-revenue">$43.6M</div></div>
        <div><div style="font-size:11px;color:var(--text3);margin-bottom:3px;">Gasto Meta</div><div style="font-size:18px;font-weight:700;" id="ov-spend">$25.1M</div></div>
        <div><div style="font-size:11px;color:var(--text3);margin-bottom:3px;">Beneficio Neto</div><div style="font-size:18px;font-weight:700;color:var(--teal);" id="ov-profit">$18.5M</div></div>
      </div>
    </div>

    <div class="kpi-grid" id="overview-kpis"></div>

    <div class="charts-grid">
      <div class="chart-card wide">
        <div class="chart-title">üìà Revenue Diario (CLP)</div>
        <div class="chart-wrap tall"><canvas id="chart-daily-revenue"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üìÖ Revenue Mensual</div>
        <div class="chart-wrap"><canvas id="chart-monthly-revenue"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üì¶ √ìrdenes Mensuales</div>
        <div class="chart-wrap"><canvas id="chart-monthly-orders"></canvas></div>
      </div>
    </div>
  </section>

  <!-- ===== META ADS ===== -->
  <section class="section" id="s-meta">
    <div class="section-title">üì£ Meta Ads</div>
    <div class="section-sub" id="meta-period">Per√≠odo filtrado</div>

    <div class="kpi-grid" id="meta-kpis"></div>

    <div class="charts-grid">
      <div class="chart-card wide">
        <div class="chart-title">üí∏ Gasto Mensual Meta + Gasto Diario Promedio</div>
        <div class="chart-wrap tall"><canvas id="chart-meta-spend"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üéØ CTR Mensual (%)</div>
        <div class="chart-wrap"><canvas id="chart-meta-ctr"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üõçÔ∏è Compras & Resultados Mensuales</div>
        <div class="chart-wrap"><canvas id="chart-meta-results"></canvas></div>
      </div>
    </div>

    <div class="table-card">
      <div class="table-header">
        <span class="table-header-title">üìã Campa√±as por Mes</span>
        <button class="export-btn" onclick="exportCSV('meta-monthly-table','meta_monthly.csv')">‚¨á CSV</button>
      </div>
      <div class="table-wrap">
        <table id="meta-monthly-table">
          <thead>
            <tr>
              <th onclick="sortTable('meta-monthly-table',0)">Mes <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',1)">Gasto <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',2)">Impr. <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',3)">Clics <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',4)">CTR <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',5)">CPC <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',6)">Mensajes <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',7)">Compras <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',8)">Resultados <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',9)">Costo/Result. <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('meta-monthly-table',10)">G.Diario <span class="sort-icon">‚ñº</span></th>
            </tr>
          </thead>
          <tbody id="meta-monthly-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="table-card">
      <div class="table-header">
        <span class="table-header-title">üèÜ Campa√±as (Global)</span>
        <button class="export-btn" onclick="exportCSV('campaigns-table','campanas.csv')">‚¨á CSV</button>
      </div>
      <div class="table-wrap">
        <table id="campaigns-table">
          <thead>
            <tr>
              <th onclick="sortTable('campaigns-table',0)">Campa√±a <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',1)">Objetivo <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',2)">Gasto <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',3)">Impr. <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',4)">Clics <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',5)">CTR <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',6)">CPC <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',7)">Mensajes <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',8)">Compras <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',9)">Resultados <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('campaigns-table',10)">Costo/Result. <span class="sort-icon">‚ñº</span></th>
            </tr>
          </thead>
          <tbody id="campaigns-tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== ADS ===== -->
  <section class="section" id="s-ads">
    <div class="section-title">üëÅÔ∏è Anuncios</div>
    <div class="section-sub">Detalle por anuncio, conjunto y campa√±a</div>
    <div class="tabs">
      <button class="tab-btn active" onclick="showAdTab('tab-ads',this)">Anuncios</button>
      <button class="tab-btn" onclick="showAdTab('tab-adsets',this)">Conjuntos</button>
      <button class="tab-btn" onclick="showAdTab('tab-campaigns-detail',this)">Campa√±as</button>
    </div>

    <!-- Ads Tab -->
    <div class="tab-content active" id="tab-ads">
      <div class="table-card">
        <div class="table-header">
          <span class="table-header-title">üì¢ Anuncios</span>
          <input class="table-search" id="ads-search" placeholder="Buscar anuncio o campa√±a‚Ä¶" oninput="filterAdsTable()"/>
          <button class="export-btn" onclick="exportCSV('ads-table','anuncios.csv')">‚¨á CSV</button>
        </div>
        <div class="table-wrap">
          <table id="ads-table">
            <thead>
              <tr>
                <th onclick="sortTable('ads-table',0)">Anuncio <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',1)">Campa√±a <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',2)">Gasto <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',3)">Impr. <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',4)">Clics <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',5)">CTR <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',6)">CPC <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',7)">CPM <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',8)">Resultados <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',9)">Costo/Result. <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',10)">Compras <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',11)">Costo/Compra <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('ads-table',12)">Mensajes <span class="sort-icon">‚ñº</span></th>
              </tr>
            </thead>
            <tbody id="ads-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Adsets Tab -->
    <div class="tab-content" id="tab-adsets">
      <div class="table-card">
        <div class="table-header">
          <span class="table-header-title">üìÇ Conjuntos de Anuncios</span>
          <button class="export-btn" onclick="exportCSV('adsets-table','conjuntos.csv')">‚¨á CSV</button>
        </div>
        <div class="table-wrap">
          <table id="adsets-table">
            <thead>
              <tr>
                <th onclick="sortTable('adsets-table',0)">Conjunto <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',1)">Campa√±a <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',2)">Gasto <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',3)">Impr. <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',4)">Clics <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',5)">CTR <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',6)">CPC <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',7)">Mensajes <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',8)">Compras <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',9)">Resultados <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('adsets-table',10)">Costo/Result. <span class="sort-icon">‚ñº</span></th>
              </tr>
            </thead>
            <tbody id="adsets-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Campaigns Detail Tab -->
    <div class="tab-content" id="tab-campaigns-detail">
      <div class="table-card">
        <div class="table-header">
          <span class="table-header-title">üèÜ Campa√±as Detalle</span>
          <button class="export-btn" onclick="exportCSV('campaigns-detail-table','campanas_detalle.csv')">‚¨á CSV</button>
        </div>
        <div class="table-wrap">
          <table id="campaigns-detail-table">
            <thead>
              <tr>
                <th onclick="sortTable('campaigns-detail-table',0)">Campa√±a <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('campaigns-detail-table',1)">Objetivo <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('campaigns-detail-table',2)">Estado <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('campaigns-detail-table',3)">Gasto <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('campaigns-detail-table',4)">CTR <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('campaigns-detail-table',5)">CPC <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('campaigns-detail-table',6)">Compras <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('campaigns-detail-table',7)">Resultados <span class="sort-icon">‚ñº</span></th>
                <th onclick="sortTable('campaigns-detail-table',8)">Costo/Result. <span class="sort-icon">‚ñº</span></th>
              </tr>
            </thead>
            <tbody id="campaigns-detail-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== SHOPIFY ===== -->
  <section class="section" id="s-shopify">
    <div class="section-title">üõí Shopify</div>
    <div class="section-sub">M√©tricas de tienda y productos</div>
    <div class="kpi-grid" id="shopify-kpis"></div>
    <div class="charts-grid">
      <div class="chart-card wide">
        <div class="chart-title">üì¶ Top 10 Productos por Revenue</div>
        <div class="chart-wrap tall"><canvas id="chart-products"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üí≥ Estado de Pago</div>
        <div class="chart-wrap"><canvas id="chart-payment"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üìä Nuevos vs Recurrentes</div>
        <div class="chart-wrap"><canvas id="chart-new-repeat"></canvas></div>
      </div>
    </div>
    <div class="table-card">
      <div class="table-header"><span class="table-header-title">üèÖ Top 10 Productos</span></div>
      <div class="table-wrap">
        <table id="products-table">
          <thead>
            <tr>
              <th>#</th>
              <th onclick="sortTable('products-table',1)">Producto <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('products-table',2)">Revenue <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('products-table',3)">Unidades <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('products-table',4)">Precio Prom. <span class="sort-icon">‚ñº</span></th>
            </tr>
          </thead>
          <tbody id="products-tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== CLIENTES ===== -->
  <section class="section" id="s-clientes">
    <div class="section-title">üë• Clientes</div>
    <div class="section-sub">An√°lisis de retenci√≥n y valor de cliente (LTV)</div>
    <div class="kpi-grid" id="clientes-kpis"></div>
    <div class="insights-grid" id="clientes-insights"></div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">üë§ Nuevos Clientes por Mes</div>
        <div class="chart-wrap"><canvas id="chart-new-clients"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üç© Distribuci√≥n de √ìrdenes por Cliente</div>
        <div class="chart-wrap"><canvas id="chart-orders-dist"></canvas></div>
      </div>
    </div>
    <div class="table-card">
      <div class="table-header"><span class="table-header-title">üìã An√°lisis de Retenci√≥n</span></div>
      <div class="table-wrap">
        <table class="retention-table">
          <thead><tr><th>Segmento</th><th>Clientes</th><th>%</th><th>LTV Prom.</th><th>Observaci√≥n</th></tr></thead>
          <tbody id="retention-tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== ANALYTICS ===== -->
  <section class="section" id="s-analytics">
    <div class="section-title">üìà Google Analytics</div>
    <div class="section-sub">Tr√°fico web y conversiones GA4</div>
    <div class="kpi-grid" id="analytics-kpis"></div>
    <div class="charts-grid">
      <div class="chart-card wide">
        <div class="chart-title">üì° Sesiones por Canal</div>
        <div class="chart-wrap"><canvas id="chart-channels-sessions"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üí∞ Revenue por Canal</div>
        <div class="chart-wrap"><canvas id="chart-channels-revenue"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üì± Dispositivos</div>
        <div class="chart-wrap"><canvas id="chart-devices"></canvas></div>
      </div>
      <div class="chart-card wide">
        <div class="chart-title">üìÖ Sesiones y Conversiones Mensuales</div>
        <div class="chart-wrap"><canvas id="chart-ga-monthly"></canvas></div>
      </div>
    </div>
    <div class="table-card">
      <div class="table-header"><span class="table-header-title">üì° Canales GA4</span></div>
      <div class="table-wrap">
        <table id="channels-table">
          <thead>
            <tr>
              <th>Canal</th>
              <th onclick="sortTable('channels-table',1)">Sesiones <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('channels-table',2)">Usuarios <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('channels-table',3)">Nuevos <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('channels-table',4)">Conv. <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('channels-table',5)">Revenue <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('channels-table',6)">Bounce % <span class="sort-icon">‚ñº</span></th>
              <th onclick="sortTable('channels-table',7)">Duraci√≥n <span class="sort-icon">‚ñº</span></th>
            </tr>
          </thead>
          <tbody id="channels-tbody"></tbody>
        </table>
      </div>
    </div>
  </section>


  <!-- FOOTER -->
  <footer id="dashboard-footer">
    <div>
      <span class="data-fresh">Datos actualizados</span>
      &nbsp;¬∑&nbsp; Kyest.cl BI Dashboard v6 &nbsp;¬∑&nbsp; Per√≠odo: Ago 2025 ‚Äì Feb 2026
    </div>
    <div style="display:flex;gap:16px;align-items:center;">
      <span>üìä <strong style="color:var(--text)">7</strong> meses de datos</span>
      <span>üõí <strong style="color:var(--teal)">250</strong> √≥rdenes</span>
      <span>üì£ <strong style="color:var(--accent)">$25.1M</strong> invertido</span>
      <span>üí∞ <strong style="color:var(--teal)">ROAS 1.74x</strong></span>
    </div>
  </footer>
</main>

<script>
// ========== DATA ==========
const RAW = {"meta_spend_total":25076610,"shopify_revenue_total":43603226,"shopify_orders_total":250,"shopify_aov":174413,"real_roas":1.739,"net_profit":18526616,"pixel_roas":2.845,"pixel_purchases":409,"meta_totals":{"spend":25076610,"impressions":10408204,"clicks":279442,"reach":1704172,"messages":2410,"purchases":409,"avg_ctr":2.367,"avg_cpc":172.6,"avg_cpm":2552.4},"daily_data":[{"date":"2025-08-23","revenue":355090},{"date":"2025-08-25","revenue":2216900},{"date":"2025-08-26","revenue":3851130},{"date":"2025-08-27","revenue":1441281},{"date":"2025-08-28","revenue":1327180},{"date":"2025-08-29","revenue":3424950},{"date":"2025-08-30","revenue":1919800},{"date":"2025-08-31","revenue":292920},{"date":"2025-09-01","revenue":621490},{"date":"2025-09-02","revenue":616000},{"date":"2025-09-04","revenue":1491400},{"date":"2025-09-05","revenue":2319025},{"date":"2025-09-06","revenue":2152200},{"date":"2025-09-08","revenue":1622570},{"date":"2025-09-09","revenue":3215320},{"date":"2025-09-10","revenue":58600},{"date":"2025-09-11","revenue":854300},{"date":"2025-09-12","revenue":1289380},{"date":"2025-09-13","revenue":315000},{"date":"2025-09-15","revenue":505695},{"date":"2025-09-16","revenue":1078400},{"date":"2025-09-17","revenue":172000},{"date":"2025-09-21","revenue":241800},{"date":"2025-09-22","revenue":999700},{"date":"2025-09-23","revenue":3245400},{"date":"2025-09-24","revenue":2550640},{"date":"2025-09-25","revenue":3001900},{"date":"2025-09-26","revenue":1960630},{"date":"2025-09-27","revenue":462525}],"monthly_data":[{"month":"2025-08","revenue":14829251,"orders":87,"new":74,"repeat":13,"aov":170451},{"month":"2025-09","revenue":28773975,"orders":163,"new":128,"repeat":35,"aov":176527}],"meta_monthly":[{"label":"Ago 25","month":"2025-08","date_start":"2025-08-23","date_stop":"2025-08-31","days":9,"spend":1089585,"impressions":782415,"clicks":77871,"ctr":9.95,"cpc":13.99,"cpm":1392.6,"reach":497557,"messages":257,"add_to_cart":76,"purchases":11,"results":268,"cost_per_result":4065.6},{"label":"Sep 25","month":"2025-09","date_start":"2025-09-01","date_stop":"2025-09-30","days":30,"spend":3499035,"impressions":2336142,"clicks":97213,"ctr":4.16,"cpc":35.99,"cpm":1497.8,"reach":564772,"messages":641,"add_to_cart":692,"purchases":73,"results":714,"cost_per_result":4900.6},{"label":"Oct 25","month":"2025-10","date_start":"2025-10-01","date_stop":"2025-10-31","days":31,"spend":4652275,"impressions":1586268,"clicks":22279,"ctr":1.40,"cpc":208.8,"cpm":2932.8,"reach":107073,"messages":342,"add_to_cart":792,"purchases":135,"results":477,"cost_per_result":9753.2},{"label":"Nov 25","month":"2025-11","date_start":"2025-11-01","date_stop":"2025-11-30","days":30,"spend":5542535,"impressions":1731151,"clicks":25348,"ctr":1.46,"cpc":218.7,"cpm":3201.6,"reach":166961,"messages":223,"add_to_cart":770,"purchases":89,"results":312,"cost_per_result":17764.5},{"label":"Dic 25","month":"2025-12","date_start":"2025-12-01","date_stop":"2025-12-31","days":31,"spend":5790159,"impressions":1971864,"clicks":26986,"ctr":1.37,"cpc":214.6,"cpm":2936.4,"reach":112508,"messages":197,"add_to_cart":458,"purchases":74,"results":271,"cost_per_result":21365.9},{"label":"Ene 26","month":"2026-01","date_start":"2026-01-01","date_stop":"2026-01-31","days":31,"spend":2896692,"impressions":1203034,"clicks":15815,"ctr":1.31,"cpc":183.2,"cpm":2407.8,"reach":109862,"messages":239,"add_to_cart":94,"purchases":16,"results":255,"cost_per_result":11359.6},{"label":"Feb 26","month":"2026-02","date_start":"2026-02-01","date_stop":"2026-02-23","days":23,"spend":1606654,"impressions":797502,"clicks":13937,"ctr":1.75,"cpc":115.3,"cpm":2014.6,"reach":102683,"messages":511,"add_to_cart":144,"purchases":11,"results":522,"cost_per_result":3077.9}],"customer_stats":{"total_unique":203,"one_order":165,"one_order_pct":81.3,"two_orders":31,"two_orders_pct":15.3,"three_plus":7,"three_plus_pct":3.4,"avg_ltv":208927,"avg_repeat_ltv":364442,"ltv_multiplier":1.7,"monthly_new":{"2025-08":74,"2025-09":128},"monthly_active":{"2025-08":74,"2025-09":138}},"financial_status":{"paid":243,"pending":7},"top_products":[{"name":"Brasile√±o | Depilaci√≥n l√°ser Alexandrita","revenue":2037600,"units":11},{"name":"Sculpt Freeze Ema","revenue":1800000,"units":1},{"name":"Sculpt Freeze abd+espalda+maf","revenue":1644200,"units":1},{"name":"Sculpt Freeze Abdomen+Espalda+6MAF+UCV","revenue":1500000,"units":1},{"name":"Axilas | Depilaci√≥n l√°ser Alexandrita","revenue":1444000,"units":20},{"name":"Piernas+Brasile√±o+Axilas | Laser","revenue":1440900,"units":3},{"name":"Sculpt Freeze","revenue":1400000,"units":1},{"name":"6 MAF+Sculpt Freeze Abdomen+Espalda","revenue":1400000,"units":1},{"name":"Brasile√±o y Axilas | Laser Alexandrita","revenue":1355400,"units":6},{"name":"Sculpt Freeze Abdomen+Espalda+Bonos","revenue":1200000,"units":1}],"campaign_rows":[{"name":"4ta ITERACI√ìN Consultas Sculpt","objective":"OUTCOME_LEADS","status":"PAUSED","spend":7168262,"impressions":2627186,"clicks":32888,"ctr":1.25,"cpc":218.0,"cpm":2728.5,"reach":474401,"messages":464,"add_to_cart":226,"purchases":73,"results":537,"cost_per_result":13348.7},{"name":"Julio Campa√±a Depilaci√≥n Laser","objective":"OUTCOME_ENGAGEMENT","status":"PAUSED","spend":1267321,"impressions":604508,"clicks":16538,"ctr":2.74,"cpc":76.6,"cpm":2096.5,"reach":243268,"messages":844,"add_to_cart":16,"purchases":3,"results":847,"cost_per_result":1496.2},{"name":"Ventas Shopy Depilaci√≥n Ago","objective":"OUTCOME_SALES","status":"PAUSED","spend":756849,"impressions":953426,"clicks":60429,"ctr":6.34,"cpc":12.5,"cpm":793.8,"reach":380807,"messages":0,"add_to_cart":34,"purchases":0,"results":0,"cost_per_result":0},{"name":"LEADS Interacci√≥n CYBER","objective":"OUTCOME_ENGAGEMENT","status":"PAUSED","spend":597179,"impressions":541730,"clicks":20380,"ctr":3.76,"cpc":29.3,"cpm":1102.4,"reach":208652,"messages":11,"add_to_cart":46,"purchases":3,"results":14,"cost_per_result":42655.6},{"name":"Ventas Julio Laser - Copia (Tr√°fico)","objective":"OUTCOME_TRAFFIC","status":"PAUSED","spend":553037,"impressions":499903,"clicks":70238,"ctr":14.05,"cpc":7.9,"cpm":1106.3,"reach":393219,"messages":0,"add_to_cart":12,"purchases":0,"results":0,"cost_per_result":0},{"name":"Interaccion Mensajes Nueva Sucursal","objective":"OUTCOME_ENGAGEMENT","status":"PAUSED","spend":254808,"impressions":136141,"clicks":2219,"ctr":1.63,"cpc":114.8,"cpm":1871.6,"reach":32137,"messages":144,"add_to_cart":4,"purchases":0,"results":144,"cost_per_result":1769.5},{"name":"AON - WEB - Venta Depilacion React","objective":"OUTCOME_SALES","status":"PAUSED","spend":193135,"impressions":53461,"clicks":930,"ctr":1.74,"cpc":207.7,"cpm":3612.6,"reach":22889,"messages":11,"add_to_cart":54,"purchases":9,"results":20,"cost_per_result":9656.8},{"name":"Leads Potenciales CYBER 13/9","objective":"OUTCOME_LEADS","status":"PAUSED","spend":27883,"impressions":12271,"clicks":206,"ctr":1.68,"cpc":135.4,"cpm":2272.3,"reach":4129,"messages":6,"add_to_cart":0,"purchases":0,"results":6,"cost_per_result":4647.2},{"name":"2da ITERACI√ìN Consultas Sculpt Freeze","objective":"OUTCOME_LEADS","status":"PAUSED","spend":7306,"impressions":3061,"clicks":21,"ctr":0.69,"cpc":347.9,"cpm":2386.8,"reach":2017,"messages":0,"add_to_cart":0,"purchases":0,"results":0,"cost_per_result":0},{"name":"CBO KYEST DEPILACION LASER cyber","objective":"OUTCOME_SALES","status":"PAUSED","spend":7272,"impressions":1926,"clicks":32,"ctr":1.66,"cpc":227.3,"cpm":3775.7,"reach":1294,"messages":2,"add_to_cart":6,"purchases":1,"results":3,"cost_per_result":2424.0}],"adset_rows":[{"name":"TT (SAN FELIPE) Advantage+ RRSS/WEB/BBDD - Copia 2","campaign":"4ta ITERACI√ìN Consultas Sculpt","spend":3066756,"impressions":1155448,"clicks":15279,"ctr":1.32,"cpc":200.7,"cpm":2654.2,"reach":121749,"messages":308,"purchases":38,"results":346,"cost_per_result":8863.5},{"name":"TT (Los ANDES) Advantage+ RRSS/WEB/BBDD","campaign":"4ta ITERACI√ìN Consultas Sculpt","spend":2424172,"impressions":828969,"clicks":8184,"ctr":0.99,"cpc":296.2,"cpm":2924.3,"reach":213628,"messages":45,"purchases":6,"results":51,"cost_per_result":47532.8},{"name":"TT (SAN FELIPE) Advantage+ RRSS/WEB/BBDD - Copia","campaign":"4ta ITERACI√ìN Consultas Sculpt","spend":1591219,"impressions":592374,"clicks":7646,"ctr":1.29,"cpc":208.1,"cpm":2686.2,"reach":96913,"messages":108,"purchases":28,"results":136,"cost_per_result":11700.1},{"name":"Winners videos","campaign":"Ventas Julio Laser - Copia (Tr√°fico)","spend":858163,"impressions":645840,"clicks":71903,"ctr":11.13,"cpc":11.9,"cpm":1328.8,"reach":422765,"messages":136,"purchases":3,"results":139,"cost_per_result":6173.8},{"name":"winners organicos","campaign":"Julio Campa√±a Depilaci√≥n Laser","spend":554507,"impressions":244694,"clicks":12403,"ctr":5.07,"cpc":44.7,"cpm":2266.1,"reach":121765,"messages":505,"purchases":0,"results":505,"cost_per_result":1098.0},{"name":"video ads leads","campaign":"LEADS Interacci√≥n CYBER","spend":453861,"impressions":457875,"clicks":18592,"ctr":4.06,"cpc":24.4,"cpm":991.2,"reach":181936,"messages":2,"purchases":1,"results":3,"cost_per_result":151287.0},{"name":"videos rehechos","campaign":"Julio Campa√±a Depilaci√≥n Laser","spend":407688,"impressions":213877,"clicks":2470,"ctr":1.15,"cpc":165.1,"cpm":1906.2,"reach":91957,"messages":203,"purchases":0,"results":203,"cost_per_result":2008.3},{"name":"CATALOGO 2025-08","campaign":"Ventas Shopy Depilaci√≥n Ago","spend":379458,"impressions":607267,"clicks":31000,"ctr":5.10,"cpc":12.2,"cpm":624.9,"reach":169724,"messages":0,"purchases":0,"results":0,"cost_per_result":0},{"name":"winner videos depilacion","campaign":"Ventas Shopy Depilaci√≥n Ago","spend":376160,"impressions":344390,"clicks":29365,"ctr":8.53,"cpc":12.8,"cpm":1092.3,"reach":209338,"messages":0,"purchases":0,"results":0,"cost_per_result":0},{"name":"TT Advantage+ RRSS/WEB/BBDD - Nueva Sucursal","campaign":"Interaccion Mensajes Nueva Sucursal","spend":254808,"impressions":136141,"clicks":2219,"ctr":1.63,"cpc":114.8,"cpm":1871.6,"reach":32137,"messages":144,"purchases":0,"results":144,"cost_per_result":1769.5}],"ads_rows":[{"ad_name":"Video 1 CTA Mas Informaci√≥n - Copia 2","adset_name":"TT (SAN FELIPE) - Copia 2","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":2574008,"impressions":1011064,"clicks":13825,"ctr":1.37,"cpc":186.2,"cpm":2545.8,"reach":79103,"link_clicks":8633,"add_to_cart":74,"purchases":27,"messages":278,"results":305,"cost_per_result":8439.4,"cost_per_purchase":95333.6},{"ad_name":"Video 1 CTA Mas Informaci√≥n - Copia 2","adset_name":"TT (SAN FELIPE) - Copia","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":1107095,"impressions":447597,"clicks":6111,"ctr":1.37,"cpc":181.2,"cpm":2473.4,"reach":58170,"link_clicks":3914,"add_to_cart":82,"purchases":20,"messages":92,"results":112,"cost_per_result":9884.8,"cost_per_purchase":55354.8},{"ad_name":"Gr√°fica 3 CTA Mas Informaci√≥n (Los Andes)","adset_name":"TT (Los ANDES)","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":860152,"impressions":312048,"clicks":2878,"ctr":0.92,"cpc":298.9,"cpm":2756.5,"reach":54656,"link_clicks":1796,"add_to_cart":4,"purchases":0,"messages":22,"results":22,"cost_per_result":39097.8,"cost_per_purchase":0},{"ad_name":"Gr√°fica 1 CTA Mas Informaci√≥n (Los Andes)","adset_name":"TT (Los ANDES)","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":815525,"impressions":285607,"clicks":2560,"ctr":0.90,"cpc":318.6,"cpm":2855.4,"reach":46789,"link_clicks":1717,"add_to_cart":8,"purchases":1,"messages":9,"results":10,"cost_per_result":81552.5,"cost_per_purchase":815525},{"ad_name":"Brasile√±o Miami (org√°nico)","adset_name":"winners organicos","campaign_name":"Julio Campa√±a Depilaci√≥n Laser","spend":554507,"impressions":244694,"clicks":12403,"ctr":5.07,"cpc":44.7,"cpm":2266.1,"reach":121765,"link_clicks":9590,"add_to_cart":4,"purchases":0,"messages":505,"results":505,"cost_per_result":1098.0,"cost_per_purchase":0},{"ad_name":"Reel Org 18/06 CTA Enviar Mensaje - Copia 4","adset_name":"Winners videos","campaign_name":"Ventas Julio Laser - Copia (Tr√°fico)","spend":540756,"impressions":487506,"clicks":69215,"ctr":14.20,"cpc":7.8,"cpm":1109.2,"reach":382326,"link_clicks":67058,"add_to_cart":10,"purchases":0,"messages":0,"results":0,"cost_per_result":0,"cost_per_purchase":0},{"ad_name":"Se viene cyber! Registrate","adset_name":"video ads leads","campaign_name":"LEADS Interacci√≥n CYBER","spend":394021,"impressions":400888,"clicks":16537,"ctr":4.13,"cpc":23.8,"cpm":982.9,"reach":151983,"link_clicks":15588,"add_to_cart":6,"purchases":1,"messages":2,"results":3,"cost_per_result":131340.3,"cost_per_purchase":394021},{"ad_name":"All Products - Ventas (cat√°logo brasile√±o)","adset_name":"CATALOGO 2025-08","campaign_name":"Ventas Shopy Depilaci√≥n Ago","spend":379458,"impressions":607267,"clicks":31000,"ctr":5.10,"cpc":12.2,"cpm":624.9,"reach":169724,"link_clicks":29979,"add_to_cart":20,"purchases":0,"messages":0,"results":0,"cost_per_result":0,"cost_per_purchase":0},{"ad_name":"Nueva Sucursal Reel CTA Mensaje - Copia","adset_name":"Winners videos","campaign_name":"Julio Campa√±a Depilaci√≥n Laser","spend":261825,"impressions":121491,"clicks":1419,"ctr":1.17,"cpc":184.5,"cpm":2155.1,"reach":19165,"link_clicks":461,"add_to_cart":12,"purchases":2,"messages":115,"results":117,"cost_per_result":2237.8,"cost_per_purchase":130912.5},{"ad_name":"Reel Nueva Sucursal CTA Mensaje","adset_name":"TT Advantage+ Nueva Sucursal","campaign_name":"Interaccion Mensajes Nueva Sucursal","spend":254808,"impressions":136141,"clicks":2219,"ctr":1.63,"cpc":114.8,"cpm":1871.6,"reach":32137,"link_clicks":483,"add_to_cart":4,"purchases":0,"messages":144,"results":144,"cost_per_result":1769.5,"cost_per_purchase":0},{"ad_name":"Gr√°fica 1 CTA Info - Copia (San Felipe)","adset_name":"TT (SAN FELIPE) - Copia","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":244451,"impressions":78248,"clicks":754,"ctr":0.96,"cpc":324.2,"cpm":3124.1,"reach":15675,"link_clicks":544,"add_to_cart":2,"purchases":3,"messages":12,"results":15,"cost_per_result":16296.7,"cost_per_purchase":81483.7},{"ad_name":"Video 3 CTA Info - Copia (San Felipe)","adset_name":"TT (SAN FELIPE) - Copia 2","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":219662,"impressions":67518,"clicks":669,"ctr":0.99,"cpc":328.3,"cpm":3253.4,"reach":14347,"link_clicks":495,"add_to_cart":8,"purchases":3,"messages":12,"results":15,"cost_per_result":14644.1,"cost_per_purchase":73220.7},{"ad_name":"All Products - Ventas (cat√°logo)","adset_name":"winner videos depilacion","campaign_name":"Ventas Shopy Depilaci√≥n Ago","spend":181229,"impressions":185647,"clicks":15282,"ctr":8.23,"cpc":11.9,"cpm":976.2,"reach":109427,"link_clicks":14046,"add_to_cart":12,"purchases":0,"messages":0,"results":0,"cost_per_result":0,"cost_per_purchase":0},{"ad_name":"video 2 LEANDRA","adset_name":"videos rehechos","campaign_name":"Julio Campa√±a Depilaci√≥n Laser","spend":169443,"impressions":79397,"clicks":1036,"ctr":1.30,"cpc":163.6,"cpm":2134.1,"reach":29209,"link_clicks":412,"add_to_cart":0,"purchases":0,"messages":92,"results":92,"cost_per_result":1841.8,"cost_per_purchase":0},{"ad_name":"org√°nico video (depilaci√≥n)","adset_name":"winner videos depilacion","campaign_name":"Ventas Shopy Depilaci√≥n Ago","spend":166143,"impressions":129594,"clicks":12594,"ctr":9.72,"cpc":13.2,"cpm":1282.0,"reach":77391,"link_clicks":12123,"add_to_cart":2,"purchases":0,"messages":0,"results":0,"cost_per_result":0,"cost_per_purchase":0},{"ad_name":"Gr√°fica 3 Info (Los Andes copia)","adset_name":"TT (Los ANDES)","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":157511,"impressions":56653,"clicks":743,"ctr":1.31,"cpc":212.0,"cpm":2780.3,"reach":19439,"link_clicks":405,"add_to_cart":0,"purchases":0,"messages":1,"results":1,"cost_per_result":157511,"cost_per_purchase":0},{"ad_name":"Video 1 CTA Info (Los Andes)","adset_name":"TT (Los ANDES)","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":128523,"impressions":36612,"clicks":482,"ctr":1.32,"cpc":266.6,"cpm":3510.4,"reach":12054,"link_clicks":388,"add_to_cart":2,"purchases":0,"messages":5,"results":5,"cost_per_result":25704.6,"cost_per_purchase":0},{"ad_name":"Gr√°fica 1 Info - Copia (San Felipe 2)","adset_name":"TT (SAN FELIPE) - Copia 2","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":113545,"impressions":28860,"clicks":332,"ctr":1.15,"cpc":342.0,"cpm":3934.3,"reach":8848,"link_clicks":209,"add_to_cart":6,"purchases":2,"messages":5,"results":7,"cost_per_result":16220.7,"cost_per_purchase":56772.5},{"ad_name":"video 2 - HOOK ABI","adset_name":"videos rehechos","campaign_name":"Julio Campa√±a Depilaci√≥n Laser","spend":109774,"impressions":59725,"clicks":591,"ctr":0.99,"cpc":185.7,"cpm":1838.0,"reach":22828,"link_clicks":282,"add_to_cart":0,"purchases":0,"messages":40,"results":40,"cost_per_result":2744.4,"cost_per_purchase":0},{"ad_name":"Gr√°fica 3 Info - Copia (San Felipe)","adset_name":"TT (SAN FELIPE) - Copia","campaign_name":"4ta ITERACI√ìN Consultas Sculpt","spend":100880,"impressions":32088,"clicks":342,"ctr":1.07,"cpc":295.0,"cpm":3143.9,"reach":10024,"link_clicks":218,"add_to_cart":2,"purchases":3,"messages":1,"results":4,"cost_per_result":25220,"cost_per_purchase":33626.7}],"ga4_channels":[{"channel":"Paid Social","sessions":2879,"users":2249,"new":2219,"conv":1,"revenue":50000,"bounce":75.3,"duration":84},{"channel":"Organic Search","sessions":1131,"users":690,"new":678,"conv":5,"revenue":642000,"bounce":32.9,"duration":239},{"channel":"Direct","sessions":1089,"users":797,"new":798,"conv":25,"revenue":3892750,"bounce":48.9,"duration":132},{"channel":"Organic Social","sessions":1052,"users":912,"new":889,"conv":5,"revenue":615090,"bounce":48.2,"duration":126},{"channel":"Paid Other","sessions":648,"users":351,"new":325,"conv":0,"revenue":0,"bounce":64.8,"duration":0},{"channel":"Referral","sessions":187,"users":107,"new":100,"conv":0,"revenue":0,"bounce":40.6,"duration":367},{"channel":"Unassigned","sessions":144,"users":98,"new":35,"conv":2,"revenue":50000,"bounce":0,"duration":0},{"channel":"Organic Shopping","sessions":50,"users":10,"new":7,"conv":1,"revenue":0,"bounce":0,"duration":0},{"channel":"Email","sessions":29,"users":12,"new":10,"conv":0,"revenue":0,"bounce":0,"duration":0},{"channel":"Paid Search","sessions":7,"users":7,"new":7,"conv":0,"revenue":0,"bounce":0,"duration":0}],"ga4_monthly":[{"month":"Ene 2026","sessions":2523,"users":1885,"new":1883,"conv":18,"revenue":2161150},{"month":"Feb 2026","sessions":4638,"users":3289,"new":3185,"conv":21,"revenue":3088690}],"ga4_devices":[{"device":"Mobile","sessions":5972,"users":4576,"conv":31,"revenue":4931340,"duration":131,"bounce":60},{"device":"Desktop","sessions":1046,"users":482,"conv":7,"revenue":225000,"duration":333,"bounce":43},{"device":"Tablet","sessions":48,"users":39,"conv":1,"revenue":93500,"duration":222,"bounce":54}]};

// ========== STATE ==========
const COLORS=['#3478F6','#0D9488','#D97706','#7C3AED','#DC2626','#0891B2','#65A30D'];
let filterStart=null,filterEnd=null;
let charts={};
let sidebarCollapsed=false;

// ========== UTILITIES ==========
function fmt(n){
  if(n===undefined||n===null)return '-';
  if(n>=1000000)return'$'+(n/1000000).toFixed(1)+'M';
  if(n>=1000)return'$'+(n/1000).toFixed(0)+'K';
  return'$'+Math.round(n).toLocaleString('es-CL');
}
function fmtNum(n){
  if(n===undefined||n===null)return '-';
  if(n>=1000000)return(n/1000000).toFixed(2)+'M';
  if(n>=1000)return(n/1000).toFixed(1)+'K';
  return n.toLocaleString('es-CL');
}
function fmtCLP(n){
  if(!n)return'-';
  return '$'+Math.round(n).toLocaleString('es-CL')+' CLP';
}
function ctrClass(v){return v<1?'ctr-red':v<2?'ctr-yellow':'ctr-green';}
function cpcClass(v){return v<50?'ctr-green':v<200?'ctr-yellow':'ctr-red';}

function chartDefaults(){
  return{
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#8B9BB4',font:{size:12}}},tooltip:{backgroundColor:'#1A2332',borderColor:'#263348',borderWidth:1,titleColor:'#E2E8F0',bodyColor:'#8B9BB4'}},
    scales:{x:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'#526072',font:{size:11}}},y:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'#526072',font:{size:11}}}}
  };
}
function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id];}}

// ========== DATE FILTER ==========
function getFilteredDailyData(){
  if(!filterStart&&!filterEnd)return RAW.daily_data;
  return RAW.daily_data.filter(d=>{
    const dt=new Date(d.date);
    const fs=filterStart?new Date(filterStart):new Date('2020-01-01');
    const fe=filterEnd?new Date(filterEnd):new Date('2030-01-01');
    return dt>=fs&&dt<=fe;
  });
}
function getFilteredMetaMonthly(){
  if(!filterStart&&!filterEnd)return RAW.meta_monthly;
  return RAW.meta_monthly.filter(m=>{
    const start=new Date(m.date_start);
    const stop=new Date(m.date_stop);
    const fs=filterStart?new Date(filterStart):new Date('2020-01-01');
    const fe=filterEnd?new Date(filterEnd):new Date('2030-01-01');
    return start<=fe&&stop>=fs;
  });
}
function getFilteredMetaTotals(){
  const mm=getFilteredMetaMonthly();
  if(!mm.length)return{spend:0,impressions:0,clicks:0,messages:0,purchases:0,results:0,add_to_cart:0,reach:0,days:0};
  const s=mm.reduce((a,m)=>a+m.spend,0);
  const i=mm.reduce((a,m)=>a+m.impressions,0);
  const c=mm.reduce((a,m)=>a+m.clicks,0);
  return{
    spend:s,impressions:i,clicks:c,
    messages:mm.reduce((a,m)=>a+m.messages,0),
    purchases:mm.reduce((a,m)=>a+m.purchases,0),
    results:mm.reduce((a,m)=>a+m.results,0),
    add_to_cart:mm.reduce((a,m)=>a+m.add_to_cart,0),
    reach:mm.reduce((a,m)=>a+m.reach,0),
    days:mm.reduce((a,m)=>a+m.days,0),
    avg_ctr:i>0?(c/i*100):0,
    avg_cpc:c>0?(s/c):0,
    avg_cpm:i>0?(s/i*1000):0
  };
}
function getFilteredRevenue(){
  return getFilteredDailyData().reduce((a,d)=>a+d.revenue,0);
}

// ========== UPDATE ALL ==========
function updateAll(){
  renderOverview();
  renderMeta();
  renderAds();
  renderShopify();
  renderClientes();
  renderAnalytics();
}

// ========== OVERVIEW ==========
function renderOverview(){
  const mt=getFilteredMetaTotals();
  const rev=getFilteredRevenue();
  const roas=mt.spend>0?(rev/mt.spend):0;
  const orders=RAW.shopify_orders_total;
  const aov=RAW.shopify_aov;

  // ROAS card
  const roasEl=document.getElementById('ov-roas-val');
  roasEl.textContent=roas.toFixed(2)+'x';
  roasEl.className='roas-big '+(roas<1.5?'red':roas<3?'yellow':'green');
  document.getElementById('ov-roas-sub').textContent=orders+' √≥rdenes ¬∑ $'+Math.round(aov/1000)+'K promedio/venta';
  document.getElementById('ov-revenue').textContent=fmt(rev);
  document.getElementById('ov-spend').textContent=fmt(mt.spend);
  document.getElementById('ov-profit').textContent=fmt(rev-mt.spend);

  // KPIs
  const kpis=[
    {label:'√ìrdenes Totales',value:fmtNum(orders),sub:'Per√≠odo completo',cls:''},
    {label:'AOV (Ticket Prom.)',value:'$'+Math.round(aov/1000)+'K',sub:'Por orden',cls:'teal'},
    {label:'Gasto Meta Total',value:fmt(mt.spend),sub:'Inversi√≥n publicitaria',cls:'amber'},
    {label:'Pixel ROAS',value:RAW.pixel_roas+'x',sub:'Atrib. pixel (no confiable)',cls:'purple'},
    {label:'Impresiones Meta',value:fmtNum(mt.impressions),sub:'Total per√≠odo',cls:''},
    {label:'Clics Meta',value:fmtNum(mt.clicks),sub:'Total clicks',cls:'teal'},
    {label:'CTR Promedio',value:mt.avg_ctr.toFixed(2)+'%',sub:'Click-through rate',cls:mt.avg_ctr<1?'red':mt.avg_ctr<2?'amber':'teal'},
    {label:'CPC Promedio',value:'$'+Math.round(mt.avg_cpc),sub:'Por click',cls:''}
  ];
  document.getElementById('overview-kpis').innerHTML=kpis.map(k=>`
    <div class="kpi-card ${k.cls}">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');

  // Daily revenue chart
  const dd=getFilteredDailyData();
  destroyChart('daily-revenue');
  const ctx1=document.getElementById('chart-daily-revenue').getContext('2d');
  charts['daily-revenue']=new Chart(ctx1,{
    type:'bar',
    data:{labels:dd.map(d=>d.date.slice(5)),datasets:[{label:'Revenue CLP',data:dd.map(d=>d.revenue),backgroundColor:'rgba(52,120,246,0.7)',borderColor:'#3478F6',borderWidth:1,borderRadius:3}]},
    options:{...chartDefaults(),plugins:{...chartDefaults().plugins,legend:{display:false}},scales:{x:{...chartDefaults().scales.x},y:{...chartDefaults().scales.y,ticks:{...chartDefaults().scales.y.ticks,callback:v=>fmt(v)}}}}
  });

  // Monthly revenue
  destroyChart('monthly-revenue');
  const ctx2=document.getElementById('chart-monthly-revenue').getContext('2d');
  charts['monthly-revenue']=new Chart(ctx2,{
    type:'bar',
    data:{labels:RAW.monthly_data.map(m=>m.month),datasets:[{label:'Revenue',data:RAW.monthly_data.map(m=>m.revenue),backgroundColor:[COLORS[0],COLORS[1]],borderRadius:4}]},
    options:{...chartDefaults(),plugins:{...chartDefaults().plugins,legend:{display:false}},scales:{x:{...chartDefaults().scales.x},y:{...chartDefaults().scales.y,ticks:{...chartDefaults().scales.y.ticks,callback:v=>fmt(v)}}}}
  });

  // Monthly orders
  destroyChart('monthly-orders');
  const ctx3=document.getElementById('chart-monthly-orders').getContext('2d');
  charts['monthly-orders']=new Chart(ctx3,{
    type:'bar',
    data:{labels:RAW.monthly_data.map(m=>m.month),datasets:[{label:'√ìrdenes',data:RAW.monthly_data.map(m=>m.orders),backgroundColor:[COLORS[2],COLORS[3]],borderRadius:4}]},
    options:{...chartDefaults(),plugins:{...chartDefaults().plugins,legend:{display:false}}}
  });
}

// ========== META ==========
function renderMeta(){
  const mt=getFilteredMetaTotals();
  const mm=getFilteredMetaMonthly();
  const rev=getFilteredRevenue();
  const roas=mt.spend>0?(rev/mt.spend):0;
  const dailySpend=mt.days>0?(mt.spend/mt.days):0;

  // Alert banners
  const banner = document.getElementById('perf-banner');
  const roas2 = getFilteredMetaTotals().spend > 0 ? getFilteredRevenue() / getFilteredMetaTotals().spend : 0;
  if(roas2 < 1.5) {
    banner.innerHTML = '<div class="alert-banner warning">‚ö† ROAS Real ' + roas2.toFixed(2) + 'x ‚Äî Por debajo del umbral m√≠nimo de 1.5x. Revisar estrategia de campa√±as.</div>';
    banner.style.display = 'block';
  } else if(roas2 >= 3) {
    banner.innerHTML = '<div class="alert-banner success">‚úì ROAS Real excelente: ' + roas2.toFixed(2) + 'x ‚Äî Por encima del objetivo.</div>';
  } else {
    banner.innerHTML = '<div class="alert-banner info">‚Ñπ ROAS Real ' + roas2.toFixed(2) + 'x ‚Äî En rango aceptable (1.5‚Äì3x).</div>';
  }
  document.getElementById('meta-period').textContent=mm.length?`${mm[0].label} ‚Üí ${mm[mm.length-1].label} ¬∑ ${mm.length} mes(es)`:'Sin datos';

  const kpis=[
    {label:'Gasto Total',value:fmt(mt.spend),sub:'Inversi√≥n Meta Ads',cls:'amber'},
    {label:'ROAS Real',value:roas.toFixed(2)+'x',sub:'Revenue / Gasto real',cls:roas<1.5?'red':roas<3?'':' teal'},
    {label:'Pixel ROAS',value:RAW.pixel_roas+'x',sub:'‚ö† Pixel (no confiable)',cls:'purple'},
    {label:'Gasto Diario Prom.',value:'$'+Math.round(dailySpend/1000)+'K/d√≠a',sub:`${mt.days} d√≠as activos`,cls:''},
    {label:'Impresiones',value:fmtNum(mt.impressions),sub:'Total impresiones',cls:''},
    {label:'Clics',value:fmtNum(mt.clicks),sub:'Total clics',cls:'teal'},
    {label:'CTR Promedio',value:mt.avg_ctr.toFixed(2)+'%',sub:'Click-through rate',cls:mt.avg_ctr<1?'red':mt.avg_ctr<2?'amber':'teal'},
    {label:'CPC Promedio',value:'$'+Math.round(mt.avg_cpc),sub:'Costo por clic',cls:mt.avg_cpc<50?'teal':mt.avg_cpc<200?'amber':'red'},
    {label:'CPM Promedio',value:'$'+Math.round(mt.avg_cpm),sub:'Costo por mil impr.',cls:''},
    {label:'Mensajes',value:fmtNum(mt.messages),sub:'Conversaciones iniciadas',cls:'teal'},
    {label:'Compras (Pixel)',value:fmtNum(mt.purchases),sub:'Atribuidas por Meta',cls:'purple'},
    {label:'Resultados',value:fmtNum(mt.results),sub:'Total resultados',cls:''}
  ];
  document.getElementById('meta-kpis').innerHTML=kpis.map(k=>`
    <div class="kpi-card ${k.cls}">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');

  // Monthly spend chart
  destroyChart('meta-spend');
  const ctx=document.getElementById('chart-meta-spend').getContext('2d');
  charts['meta-spend']=new Chart(ctx,{
    type:'bar',
    data:{
      labels:mm.map(m=>m.label),
      datasets:[
        {label:'Gasto Mensual',data:mm.map(m=>m.spend),backgroundColor:'rgba(52,120,246,0.7)',borderColor:COLORS[0],borderWidth:1,borderRadius:3,yAxisID:'y'},
        {label:'Gasto Diario (l√≠nea)',data:mm.map(m=>m.days>0?Math.round(m.spend/m.days):0),type:'line',borderColor:COLORS[2],backgroundColor:'rgba(217,119,6,0.1)',tension:.4,pointRadius:4,yAxisID:'y1'}
      ]
    },
    options:{...chartDefaults(),scales:{x:{...chartDefaults().scales.x},y:{...chartDefaults().scales.y,ticks:{...chartDefaults().scales.y.ticks,callback:v=>fmt(v)}},y1:{position:'right',grid:{drawOnChartArea:false},ticks:{color:'#526072',font:{size:11},callback:v=>'$'+Math.round(v/1000)+'K'}}}}
  });

  // CTR chart
  destroyChart('meta-ctr');
  const ctx2=document.getElementById('chart-meta-ctr').getContext('2d');
  charts['meta-ctr']=new Chart(ctx2,{
    type:'line',
    data:{labels:mm.map(m=>m.label),datasets:[{label:'CTR %',data:mm.map(m=>m.ctr),borderColor:COLORS[1],backgroundColor:'rgba(13,148,136,0.1)',tension:.4,pointRadius:4,fill:true}]},
    options:{...chartDefaults(),plugins:{...chartDefaults().plugins,legend:{display:false}},scales:{x:{...chartDefaults().scales.x},y:{...chartDefaults().scales.y,ticks:{...chartDefaults().scales.y.ticks,callback:v=>v+'%'}}}}
  });

  // Results chart
  destroyChart('meta-results');
  const ctx3=document.getElementById('chart-meta-results').getContext('2d');
  charts['meta-results']=new Chart(ctx3,{
    type:'bar',
    data:{
      labels:mm.map(m=>m.label),
      datasets:[
        {label:'Compras',data:mm.map(m=>m.purchases),backgroundColor:COLORS[1],borderRadius:3},
        {label:'Resultados',data:mm.map(m=>m.results),backgroundColor:COLORS[0],borderRadius:3}
      ]
    },
    options:{...chartDefaults()}
  });

  // Meta monthly table
  const tbody=document.getElementById('meta-monthly-tbody');
  tbody.innerHTML=mm.map(m=>{
    const daily=m.days>0?Math.round(m.spend/m.days):0;
    return`<tr>
      <td class="td-bold">${m.label}</td>
      <td>${fmt(m.spend)}</td>
      <td>${fmtNum(m.impressions)}</td>
      <td>${fmtNum(m.clicks)}</td>
      <td class="${ctrClass(m.ctr)}">${m.ctr.toFixed(2)}%</td>
      <td class="${cpcClass(m.cpc)}">$${Math.round(m.cpc)}</td>
      <td>${m.messages}</td>
      <td>${m.purchases}</td>
      <td>${m.results}</td>
      <td class="td-bold">$${Math.round(m.cost_per_result).toLocaleString('es-CL')}</td>
      <td>${fmt(daily)}/d√≠a</td>
    </tr>`;
  }).join('');

  // Campaigns table
  const maxSpend=Math.max(...RAW.campaign_rows.map(r=>r.spend));
  const maxCTR=Math.max(...RAW.campaign_rows.map(r=>r.ctr));
  const minCPR=Math.min(...RAW.campaign_rows.filter(r=>r.cost_per_result>0).map(r=>r.cost_per_result));
  document.getElementById('campaigns-tbody').innerHTML=RAW.campaign_rows.map(r=>{
    const isBest=r.spend===maxSpend?'üî• ':r.ctr===maxCTR?'üèÜ ':r.cost_per_result===minCPR&&r.cost_per_result>0?'‚≠ê ':'';
    return`<tr>
      <td class="td-name" title="${r.name}">${isBest}${r.name}</td>
      <td><span class="obj-badge obj-${r.objective.toLowerCase().replace('outcome_','')}">${r.objective.replace('OUTCOME_','')}</span></td>
      <td>${fmt(r.spend)}</td>
      <td>${fmtNum(r.impressions)}</td>
      <td>${fmtNum(r.clicks)}</td>
      <td class="${ctrClass(r.ctr)}">${r.ctr.toFixed(2)}%</td>
      <td class="${cpcClass(r.cpc)}">$${Math.round(r.cpc)}</td>
      <td>${r.messages}</td>
      <td>${r.purchases}</td>
      <td>${r.results}</td>
      <td class="td-bold">$${r.cost_per_result>0?Math.round(r.cost_per_result).toLocaleString('es-CL'):'-'}</td>
    </tr>`;
  }).join('');
}

// ========== ADS ==========
function renderAds(){
  renderAdsTable();
  renderAdsetsTable();
  renderCampaignsDetailTable();
}

function renderAdsTable(filter=''){
  const ads=filter?RAW.ads_rows.filter(a=>a.ad_name.toLowerCase().includes(filter.toLowerCase())||a.campaign_name.toLowerCase().includes(filter.toLowerCase())):RAW.ads_rows;
  const sorted=[...ads].sort((a,b)=>b.spend-a.spend);
  const maxSpend=Math.max(...sorted.map(r=>r.spend));
  const maxCTR=Math.max(...sorted.map(r=>r.ctr));
  const minCPR=Math.min(...sorted.filter(r=>r.cost_per_result>0).map(r=>r.cost_per_result));
  document.getElementById('ads-tbody').innerHTML=sorted.map(r=>{
    const badge=r.spend===maxSpend?'üî•':r.ctr===maxCTR?'üèÜ':r.cost_per_result===minCPR&&r.cost_per_result>0?'‚≠ê':'';
    return`<tr>
      <td class="td-name" title="${r.ad_name}">${badge?badge+' ':''}<span class="td-bold">${r.ad_name}</span></td>
      <td class="td-name" style="color:var(--text2);font-size:12px;" title="${r.campaign_name}">${r.campaign_name}</td>
      <td>${fmt(r.spend)}</td>
      <td>${fmtNum(r.impressions)}</td>
      <td>${fmtNum(r.clicks)}</td>
      <td class="${ctrClass(r.ctr)}">${r.ctr.toFixed(2)}%</td>
      <td class="${cpcClass(r.cpc)}">$${Math.round(r.cpc)}</td>
      <td>$${Math.round(r.cpm)}</td>
      <td>${r.results}</td>
      <td class="td-bold" style="color:var(--accent)">$${r.cost_per_result>0?Math.round(r.cost_per_result).toLocaleString('es-CL'):'-'}</td>
      <td>${r.purchases}</td>
      <td style="color:var(--text2);font-size:12px;">$${r.cost_per_purchase>0?Math.round(r.cost_per_purchase).toLocaleString('es-CL'):'-'}</td>
      <td>${r.messages}</td>
    </tr>`;
  }).join('');
}

function filterAdsTable(){
  const v=document.getElementById('ads-search').value;
  renderAdsTable(v);
}

function renderAdsetsTable(){
  const sorted=[...RAW.adset_rows].sort((a,b)=>b.spend-a.spend);
  document.getElementById('adsets-tbody').innerHTML=sorted.map(r=>`<tr>
    <td class="td-name td-bold" title="${r.name}">${r.name}</td>
    <td class="td-name" style="color:var(--text2);font-size:12px;" title="${r.campaign}">${r.campaign}</td>
    <td>${fmt(r.spend)}</td>
    <td>${fmtNum(r.impressions)}</td>
    <td>${fmtNum(r.clicks)}</td>
    <td class="${ctrClass(r.ctr)}">${r.ctr.toFixed(2)}%</td>
    <td class="${cpcClass(r.cpc)}">$${Math.round(r.cpc)}</td>
    <td>${r.messages}</td>
    <td>${r.purchases}</td>
    <td>${r.results}</td>
    <td class="td-bold" style="color:var(--accent)">$${r.cost_per_result>0?Math.round(r.cost_per_result).toLocaleString('es-CL'):'-'}</td>
  </tr>`).join('');
}

function renderCampaignsDetailTable(){
  const sorted=[...RAW.campaign_rows].sort((a,b)=>b.spend-a.spend);
  document.getElementById('campaigns-detail-tbody').innerHTML=sorted.map(r=>`<tr>
    <td class="td-name td-bold" title="${r.name}">${r.name}</td>
    <td style="font-size:12px;color:var(--text2)">${r.objective.replace('OUTCOME_','')}</td>
    <td><span class="status-badge ${r.status==='ACTIVE'?'status-active':'status-paused'}">${r.status==='ACTIVE'?'Activa':'Pausada'}</span></td>
    <td>${fmt(r.spend)}</td>
    <td class="${ctrClass(r.ctr)}">${r.ctr.toFixed(2)}%</td>
    <td class="${cpcClass(r.cpc)}">$${Math.round(r.cpc)}</td>
    <td>${r.purchases}</td>
    <td>${r.results}</td>
    <td class="td-bold" style="color:var(--accent)">$${r.cost_per_result>0?Math.round(r.cost_per_result).toLocaleString('es-CL'):'-'}</td>
  </tr>`).join('');
}

// ========== SHOPIFY ==========
function renderShopify(){
  const kpis=[
    {label:'Revenue Total',value:fmt(RAW.shopify_revenue_total),sub:'Ingresos Shopify',cls:'teal'},
    {label:'√ìrdenes Totales',value:RAW.shopify_orders_total,sub:'Per√≠odo completo',cls:''},
    {label:'AOV (Ticket Prom.)',value:'$'+Math.round(RAW.shopify_aov/1000)+'K CLP',sub:'Valor promedio orden',cls:''},
    {label:'√ìrdenes Pagadas',value:RAW.financial_status.paid,sub:`${Math.round(RAW.financial_status.paid/RAW.shopify_orders_total*100)}% del total`,cls:'teal'},
    {label:'√ìrdenes Pendientes',value:RAW.financial_status.pending,sub:'Por cobrar',cls:'amber'},
    {label:'Ago 2025 Revenue',value:fmt(RAW.monthly_data[0].revenue),sub:`${RAW.monthly_data[0].orders} √≥rdenes`,cls:''},
    {label:'Sep 2025 Revenue',value:fmt(RAW.monthly_data[1].revenue),sub:`${RAW.monthly_data[1].orders} √≥rdenes`,cls:'teal'},
    {label:'Crecimiento MoM',value:'+'+Math.round((RAW.monthly_data[1].revenue/RAW.monthly_data[0].revenue-1)*100)+'%',sub:'Ago ‚Üí Sep',cls:'teal'}
  ];
  document.getElementById('shopify-kpis').innerHTML=kpis.map(k=>`
    <div class="kpi-card ${k.cls}">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');

  // Products chart
  destroyChart('products');
  const ctx=document.getElementById('chart-products').getContext('2d');
  charts['products']=new Chart(ctx,{
    type:'bar',
    data:{
      labels:RAW.top_products.map(p=>p.name.length>30?p.name.slice(0,28)+'‚Ä¶':p.name),
      datasets:[{label:'Revenue CLP',data:RAW.top_products.map(p=>p.revenue),backgroundColor:COLORS[0],borderRadius:4}]
    },
    options:{...chartDefaults(),indexAxis:'y',plugins:{...chartDefaults().plugins,legend:{display:false}},scales:{x:{...chartDefaults().scales.x,ticks:{...chartDefaults().scales.x.ticks,callback:v=>fmt(v)}},y:{...chartDefaults().scales.y,ticks:{...chartDefaults().scales.y.ticks,font:{size:11}}}}}
  });

  // Payment status donut
  destroyChart('payment');
  const ctx2=document.getElementById('chart-payment').getContext('2d');
  charts['payment']=new Chart(ctx2,{
    type:'doughnut',
    data:{labels:['Pagadas','Pendientes'],datasets:[{data:[RAW.financial_status.paid,RAW.financial_status.pending],backgroundColor:[COLORS[1],COLORS[2]],borderWidth:0,hoverOffset:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#8B9BB4',font:{size:12}}}}}
  });

  // New vs repeat chart
  destroyChart('new-repeat');
  const ctx3=document.getElementById('chart-new-repeat').getContext('2d');
  charts['new-repeat']=new Chart(ctx3,{
    type:'bar',
    data:{
      labels:RAW.monthly_data.map(m=>m.month),
      datasets:[
        {label:'Nuevos',data:RAW.monthly_data.map(m=>m.new),backgroundColor:COLORS[0],borderRadius:3},
        {label:'Recurrentes',data:RAW.monthly_data.map(m=>m.repeat),backgroundColor:COLORS[1],borderRadius:3}
      ]
    },
    options:{...chartDefaults()}
  });

  // Products table
  document.getElementById('products-tbody').innerHTML=RAW.top_products.map((p,i)=>`<tr>
    <td style="color:var(--text3);font-weight:600">${i+1}</td>
    <td class="td-bold" style="max-width:300px;white-space:normal;line-height:1.3">${p.name}</td>
    <td style="color:var(--teal)">${fmt(p.revenue)}</td>
    <td>${p.units}</td>
    <td>$${Math.round(p.revenue/p.units).toLocaleString('es-CL')}</td>
  </tr>`).join('');
}

// ========== CLIENTES ==========
function renderClientes(){
  const cs=RAW.customer_stats;

  // KPI cards
  const kpis=[
    {label:'Clientes √önicos',value:cs.total_unique,sub:'Total hist√≥rico',cls:''},
    {label:'1 Sola Compra',value:cs.one_order+' ('+cs.one_order_pct+'%)',sub:'‚ö† Oportunidad retenci√≥n',cls:'amber'},
    {label:'2 Compras',value:cs.two_orders+' ('+cs.two_orders_pct+'%)',sub:'Compraron dos veces',cls:''},
    {label:'3+ Compras',value:cs.three_plus+' ('+cs.three_plus_pct+'%)',sub:'Clientes fieles',cls:'teal'},
    {label:'LTV Promedio',value:fmtCLP(cs.avg_ltv),sub:'Todos los clientes',cls:''},
    {label:'LTV Recurrentes',value:fmtCLP(cs.avg_repeat_ltv),sub:`${cs.ltv_multiplier}x m√°s que promedio`,cls:'teal'},
    {label:'Nuevos (Ago)',value:cs.monthly_new['2025-08'],sub:'Agosto 2025',cls:''},
    {label:'Nuevos (Sep)',value:cs.monthly_new['2025-09'],sub:'Septiembre 2025 (+'+Math.round((cs.monthly_new['2025-09']/cs.monthly_new['2025-08']-1)*100)+'%)',cls:'teal'}
  ];
  document.getElementById('clientes-kpis').innerHTML=kpis.map(k=>`
    <div class="kpi-card ${k.cls}">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');

  // Insights
  const insights=[
    {cls:'critical',icon:'üö®',title:'Oportunidad Cr√≠tica',text:`<strong>${cs.one_order_pct}%</strong> de los clientes (${cs.one_order}/${cs.total_unique}) compr√≥ solo una vez. Activar retargeting y email marketing post-compra podr√≠a aumentar revenue en <strong>30-50%</strong>.`},
    {cls:'positive',icon:'üí°',title:'Valor de la Recurrencia',text:`Un cliente recurrente vale <strong>${cs.ltv_multiplier}x m√°s</strong> en revenue ($${Math.round(cs.avg_repeat_ltv/1000)}K vs $${Math.round(cs.avg_ltv/1000)}K CLP). Foco en retenci√≥n tiene mayor ROI que adquisici√≥n pura.`},
    {cls:'info',icon:'üìà',title:'Tendencia de Adquisici√≥n',text:`Ago 2025: <strong>${cs.monthly_new['2025-08']}</strong> nuevos clientes. Sep 2025: +${Math.round((cs.monthly_new['2025-09']/cs.monthly_new['2025-08']-1)*100)}% ‚Üí <strong>${cs.monthly_new['2025-09']}</strong> nuevos. Per√≠odo m√°s activo: <strong>Septiembre</strong> (efecto Cyber Day).`}
  ];
  document.getElementById('clientes-insights').innerHTML=insights.map(i=>`
    <div class="insight-card ${i.cls}">
      <div class="insight-icon">${i.icon}</div>
      <div class="insight-title">${i.title}</div>
      <div class="insight-text">${i.text}</div>
    </div>`).join('');

  // New clients chart
  destroyChart('new-clients');
  const months=Object.keys(cs.monthly_new);
  const ctx=document.getElementById('chart-new-clients').getContext('2d');
  charts['new-clients']=new Chart(ctx,{
    type:'bar',
    data:{
      labels:['Ago 2025','Sep 2025'],
      datasets:[
        {label:'Nuevos',data:months.map(m=>cs.monthly_new[m]),backgroundColor:COLORS[0],borderRadius:4},
        {label:'Activos',data:months.map(m=>cs.monthly_active[m]),backgroundColor:COLORS[1],borderRadius:4}
      ]
    },
    options:{...chartDefaults()}
  });

  // Donut orders dist
  destroyChart('orders-dist');
  const ctx2=document.getElementById('chart-orders-dist').getContext('2d');
  charts['orders-dist']=new Chart(ctx2,{
    type:'doughnut',
    data:{
      labels:['1 orden (81.3%)','2 √≥rdenes (15.3%)','3+ √≥rdenes (3.4%)'],
      datasets:[{data:[cs.one_order,cs.two_orders,cs.three_plus],backgroundColor:[COLORS[2],COLORS[0],COLORS[1]],borderWidth:0,hoverOffset:6}]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#8B9BB4',font:{size:12}}}}}
  });

  // Retention table
  document.getElementById('retention-tbody').innerHTML=`
    <tr><td>Compra √∫nica</td><td>${cs.one_order}</td><td style="color:var(--amber)">${cs.one_order_pct}%</td><td>$${Math.round(cs.avg_ltv/1000)}K CLP</td><td style="color:var(--amber)">‚ö† Alto riesgo churn</td></tr>
    <tr><td>2 compras</td><td>${cs.two_orders}</td><td>${cs.two_orders_pct}%</td><td>~$${Math.round(cs.avg_ltv*1.5/1000)}K CLP</td><td style="color:var(--accent)">‚Üó En progreso</td></tr>
    <tr><td>3+ compras</td><td>${cs.three_plus}</td><td style="color:var(--teal)">${cs.three_plus_pct}%</td><td style="color:var(--teal)">$${Math.round(cs.avg_repeat_ltv/1000)}K CLP</td><td style="color:var(--teal)">‚úì Clientes fieles</td></tr>
    <tr style="background:var(--surface2)"><td style="font-weight:700">TOTAL</td><td style="font-weight:700">${cs.total_unique}</td><td style="font-weight:700">100%</td><td style="font-weight:700">$${Math.round(cs.avg_ltv/1000)}K CLP</td><td>LTV promedio general</td></tr>
  `;
}

// ========== ANALYTICS ==========
function renderAnalytics(){
  const totalSessions=RAW.ga4_channels.reduce((a,c)=>a+c.sessions,0);
  const totalUsers=RAW.ga4_channels.reduce((a,c)=>a+c.users,0);
  const totalConv=RAW.ga4_channels.reduce((a,c)=>a+c.conv,0);
  const totalRevGA=RAW.ga4_channels.reduce((a,c)=>a+c.revenue,0);

  const kpis=[
    {label:'Total Sesiones',value:fmtNum(totalSessions),sub:'Todos los canales',cls:''},
    {label:'Total Usuarios',value:fmtNum(totalUsers),sub:'Usuarios √∫nicos',cls:''},
    {label:'Conversiones',value:totalConv,sub:'Objetivos completados',cls:'teal'},
    {label:'Revenue GA4',value:fmt(totalRevGA),sub:'Revenue rastreado',cls:'teal'},
    {label:'Sesiones Ene 26',value:fmtNum(RAW.ga4_monthly[0].sessions),sub:`${RAW.ga4_monthly[0].conv} conv.`,cls:''},
    {label:'Sesiones Feb 26',value:fmtNum(RAW.ga4_monthly[1].sessions),sub:`${RAW.ga4_monthly[1].conv} conv.`,cls:'teal'},
    {label:'Mobile Sessions',value:fmtNum(RAW.ga4_devices[0].sessions),sub:`${Math.round(RAW.ga4_devices[0].sessions/RAW.ga4_devices.reduce((a,d)=>a+d.sessions,0)*100)}% del total`,cls:''},
    {label:'Desktop Sessions',value:fmtNum(RAW.ga4_devices[1].sessions),sub:`${Math.round(RAW.ga4_devices[1].sessions/RAW.ga4_devices.reduce((a,d)=>a+d.sessions,0)*100)}% del total`,cls:''}
  ];
  document.getElementById('analytics-kpis').innerHTML=kpis.map(k=>`
    <div class="kpi-card ${k.cls}">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');

  // Channels sessions bar
  destroyChart('channels-sessions');
  const ctx=document.getElementById('chart-channels-sessions').getContext('2d');
  charts['channels-sessions']=new Chart(ctx,{
    type:'bar',
    data:{labels:RAW.ga4_channels.map(c=>c.channel),datasets:[{label:'Sesiones',data:RAW.ga4_channels.map(c=>c.sessions),backgroundColor:COLORS,borderRadius:3}]},
    options:{...chartDefaults(),plugins:{...chartDefaults().plugins,legend:{display:false}}}
  });

  // Channels revenue
  destroyChart('channels-revenue');
  const ctx2=document.getElementById('chart-channels-revenue').getContext('2d');
  charts['channels-revenue']=new Chart(ctx2,{
    type:'doughnut',
    data:{labels:RAW.ga4_channels.filter(c=>c.revenue>0).map(c=>c.channel),datasets:[{data:RAW.ga4_channels.filter(c=>c.revenue>0).map(c=>c.revenue),backgroundColor:COLORS,borderWidth:0,hoverOffset:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#8B9BB4',font:{size:11}}}}}
  });

  // Devices
  destroyChart('devices');
  const ctx3=document.getElementById('chart-devices').getContext('2d');
  charts['devices']=new Chart(ctx3,{
    type:'doughnut',
    data:{labels:RAW.ga4_devices.map(d=>d.device),datasets:[{data:RAW.ga4_devices.map(d=>d.sessions),backgroundColor:[COLORS[0],COLORS[1],COLORS[2]],borderWidth:0,hoverOffset:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#8B9BB4',font:{size:12}}}}}
  });

  // GA Monthly
  destroyChart('ga-monthly');
  const ctx4=document.getElementById('chart-ga-monthly').getContext('2d');
  charts['ga-monthly']=new Chart(ctx4,{
    type:'bar',
    data:{
      labels:RAW.ga4_monthly.map(m=>m.month),
      datasets:[
        {label:'Sesiones',data:RAW.ga4_monthly.map(m=>m.sessions),backgroundColor:COLORS[0],borderRadius:3,yAxisID:'y'},
        {label:'Conversiones',data:RAW.ga4_monthly.map(m=>m.conv),backgroundColor:COLORS[1],borderRadius:3,yAxisID:'y1'}
      ]
    },
    options:{...chartDefaults(),scales:{x:{...chartDefaults().scales.x},y:{...chartDefaults().scales.y},y1:{position:'right',grid:{drawOnChartArea:false},ticks:{color:'#526072',font:{size:11}}}}}
  });

  // Channels table
  document.getElementById('channels-tbody').innerHTML=RAW.ga4_channels.map(c=>`<tr>
    <td class="td-bold">${c.channel}</td>
    <td>${fmtNum(c.sessions)}</td>
    <td>${fmtNum(c.users)}</td>
    <td>${fmtNum(c.new)}</td>
    <td style="color:var(--teal)">${c.conv}</td>
    <td>${c.revenue>0?fmt(c.revenue):'-'}</td>
    <td class="${c.bounce>60?'ctr-red':c.bounce>40?'ctr-yellow':'ctr-green'}">${c.bounce>0?c.bounce.toFixed(1)+'%':'-'}</td>
    <td>${c.duration>0?c.duration+'s':'-'}</td>
  </tr>`).join('');
}

// ========== NAVIGATION ==========
function showSection(id,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
  document.getElementById('s-'+id).classList.add('active');
  if(el)el.classList.add('active');
  const titles={overview:'Overview General',meta:'Meta Ads',ads:'Anuncios',shopify:'Shopify',clientes:'Clientes',analytics:'Analytics'};
  document.getElementById('headerTitle').textContent=titles[id]||id;
}

function showAdTab(tabId,btn){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  btn.classList.add('active');
}

// ========== SIDEBAR ==========
function toggleSidebar(){
  sidebarCollapsed=!sidebarCollapsed;
  document.getElementById('sidebar').classList.toggle('collapsed',sidebarCollapsed);
  document.getElementById('header').classList.toggle('collapsed',sidebarCollapsed);
  document.getElementById('main').classList.toggle('collapsed',sidebarCollapsed);
}

function toggleMobile(){
  document.getElementById('sidebar').classList.toggle('mobile-open');
}

// ========== DATE PRESETS ==========
function setPreset(p){
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  const now=new Date();
  let start=null,end=null;
  if(p==='today'){start=end=now.toISOString().slice(0,10);}
  else if(p==='7d'){const s=new Date(now);s.setDate(s.getDate()-7);start=s.toISOString().slice(0,10);end=now.toISOString().slice(0,10);}
  else if(p==='30d'){const s=new Date(now);s.setDate(s.getDate()-30);start=s.toISOString().slice(0,10);end=now.toISOString().slice(0,10);}
  else if(p==='3m'){const s=new Date(now);s.setMonth(s.getMonth()-3);start=s.toISOString().slice(0,10);end=now.toISOString().slice(0,10);}
  else if(p==='6m'){const s=new Date(now);s.setMonth(s.getMonth()-6);start=s.toISOString().slice(0,10);end=now.toISOString().slice(0,10);}
  else{start=null;end=null;}
  filterStart=start;filterEnd=end;
  if(fp){fp.setDate(start&&end?[start,end]:null);}
  updateAll();
}

// ========== TABLE SORT ==========
function sortTable(tableId,colIdx){
  const table=document.getElementById(tableId);
  const tbody=table.querySelector('tbody');
  const rows=Array.from(tbody.querySelectorAll('tr'));
  const th=table.querySelectorAll('thead th')[colIdx];
  const asc=th.dataset.sort!=='asc';
  table.querySelectorAll('thead th').forEach(t=>{t.dataset.sort='';t.classList.remove('sorted');t.querySelector('.sort-icon').textContent='‚ñº';});
  th.dataset.sort=asc?'asc':'desc';
  th.classList.add('sorted');
  th.querySelector('.sort-icon').textContent=asc?'‚ñ≤':'‚ñº';
  rows.sort((a,b)=>{
    const av=a.cells[colIdx]?.textContent.trim().replace(/[$,M K%x]/g,'').replace('\.','').trim()||'';
    const bv=b.cells[colIdx]?.textContent.trim().replace(/[$,M K%x]/g,'').replace('\.','').trim()||'';
    const an=parseFloat(av),bn=parseFloat(bv);
    if(!isNaN(an)&&!isNaN(bn))return asc?an-bn:bn-an;
    return asc?av.localeCompare(bv,'es'):bv.localeCompare(av,'es');
  });
  rows.forEach(r=>tbody.appendChild(r));
}

// ========== CSV EXPORT ==========
function exportCSV(tableId,filename){
  const table=document.getElementById(tableId);
  const rows=Array.from(table.querySelectorAll('tr'));
  const csv=rows.map(r=>Array.from(r.cells).map(c=>'"'+c.textContent.trim().replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);
}

// ========== FLATPICKR ==========
let fp;
document.addEventListener('DOMContentLoaded',()=>{
  fp=flatpickr('#datePicker',{
    mode:'range',dateFormat:'Y-m-d',
    onChange(dates){
      if(dates.length===2){
        filterStart=dates[0].toISOString().slice(0,10);
        filterEnd=dates[1].toISOString().slice(0,10);
        document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
        updateAll();
      } else if(dates.length===0){
        filterStart=null;filterEnd=null;updateAll();
      }
    }
  });
  updateAll();
});

// ========== ADDITIONAL ANALYTICS FUNCTIONS ==========

// Calculate cohort metrics
function getCohortMetrics() {
  const cs = RAW.customer_stats;
  const repeatRate = ((cs.two_orders + cs.three_plus) / cs.total_unique * 100).toFixed(1);
  const churnRate = (cs.one_order_pct).toFixed(1);
  const avgOrdersPerCustomer = (RAW.shopify_orders_total / cs.total_unique).toFixed(2);
  const revenuePerNewCustomer = (RAW.monthly_data[0].revenue / cs.monthly_new['2025-08']).toFixed(0);
  return { repeatRate, churnRate, avgOrdersPerCustomer, revenuePerNewCustomer };
}

// Calculate Meta efficiency metrics
function getMetaEfficiency() {
  const mt = getFilteredMetaTotals();
  const rev = getFilteredRevenue();
  const costPerOrder = mt.spend > 0 && RAW.shopify_orders_total > 0 ? (mt.spend / RAW.shopify_orders_total) : 0;
  const reachRate = mt.impressions > 0 ? (mt.reach / mt.impressions * 100) : 0;
  const engagementRate = mt.impressions > 0 ? (mt.clicks / mt.impressions * 100) : 0;
  const messageRate = mt.reach > 0 ? (mt.messages / mt.reach * 100) : 0;
  return { costPerOrder, reachRate, engagementRate, messageRate };
}

// Identify best/worst performing months
function getMonthlyTrends() {
  const mm = RAW.meta_monthly;
  const bestCTR = mm.reduce((best, m) => m.ctr > best.ctr ? m : best, mm[0]);
  const worstCTR = mm.reduce((worst, m) => m.ctr < worst.ctr ? m : worst, mm[0]);
  const bestCPR = mm.filter(m => m.cost_per_result > 0).reduce((best, m) => m.cost_per_result < best.cost_per_result ? m : best, mm.find(m => m.cost_per_result > 0) || mm[0]);
  const highestSpend = mm.reduce((max, m) => m.spend > max.spend ? m : max, mm[0]);
  return { bestCTR, worstCTR, bestCPR, highestSpend };
}

// Format duration in seconds to human-readable
function fmtDuration(secs) {
  if (!secs || secs === 0) return '-';
  if (secs < 60) return secs + 's';
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  return m + 'm ' + s + 's';
}

// Format large CLP number with full precision
function fmtCLPFull(n) {
  if (!n) return '$0';
  return '$' + Math.round(n).toLocaleString('es-CL') + ' CLP';
}

// Get color class for ROAS value
function getRoasClass(v) {
  if (v < 1.5) return 'red';
  if (v < 3) return 'yellow';
  return 'green';
}

// Get color hex for ROAS
function getRoasColor(v) {
  if (v < 1.5) return '#DC2626';
  if (v < 3) return '#D97706';
  return '#0D9488';
}

// Calculate running totals for daily data
function getDailyRunningTotal() {
  const dd = getFilteredDailyData();
  let running = 0;
  return dd.map(d => {
    running += d.revenue;
    return { date: d.date, revenue: d.revenue, cumulative: running };
  });
}

// Get top ad by metric
function getTopAdByMetric(metric) {
  return RAW.ads_rows.reduce((best, ad) => (ad[metric] || 0) > (best[metric] || 0) ? ad : best, RAW.ads_rows[0]);
}

// Get ads performance summary
function getAdsPerformanceSummary() {
  const totalSpend = RAW.ads_rows.reduce((s, a) => s + a.spend, 0);
  const totalImpr = RAW.ads_rows.reduce((s, a) => s + a.impressions, 0);
  const totalClicks = RAW.ads_rows.reduce((s, a) => s + a.clicks, 0);
  const totalPurchases = RAW.ads_rows.reduce((s, a) => s + a.purchases, 0);
  const totalMessages = RAW.ads_rows.reduce((s, a) => s + a.messages, 0);
  const avgCTR = totalImpr > 0 ? (totalClicks / totalImpr * 100) : 0;
  const avgCPC = totalClicks > 0 ? (totalSpend / totalClicks) : 0;
  return { totalSpend, totalImpr, totalClicks, totalPurchases, totalMessages, avgCTR, avgCPC };
}

// Render performance section in meta
function renderMetaInsights() {
  const trends = getMonthlyTrends();
  const eff = getMetaEfficiency();
  const mt = getFilteredMetaTotals();
  
  // Add performance scorecard row
  const container = document.getElementById('s-meta');
  let scoreCard = document.getElementById('meta-score-card');
  if (!scoreCard) {
    scoreCard = document.createElement('div');
    scoreCard.id = 'meta-score-card';
    scoreCard.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:22px;';
    const kpiGrid = document.getElementById('meta-kpis');
    kpiGrid.parentNode.insertBefore(scoreCard, kpiGrid.nextSibling);
  }
  
  const roas = mt.spend > 0 ? getFilteredRevenue() / mt.spend : 0;
  const dailySpend = mt.days > 0 ? mt.spend / mt.days : 0;
  
  scoreCard.innerHTML = `
    <div style="font-size:13px;font-weight:700;margin-bottom:14px;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;">üìä An√°lisis de Rendimiento</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;">
      <div style="padding:12px;background:var(--surface2);border-radius:8px;">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px;">Mejor mes CTR</div>
        <div style="font-weight:700;color:var(--teal)">${trends.bestCTR.label}: ${trends.bestCTR.ctr.toFixed(2)}%</div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px;">vs peor: ${trends.worstCTR.label} (${trends.worstCTR.ctr.toFixed(2)}%)</div>
      </div>
      <div style="padding:12px;background:var(--surface2);border-radius:8px;">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px;">Mejor Costo/Result.</div>
        <div style="font-weight:700;color:var(--teal)">${trends.bestCPR.label}: $${Math.round(trends.bestCPR.cost_per_result).toLocaleString('es-CL')}</div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px;">Per√≠odo m√°s eficiente</div>
      </div>
      <div style="padding:12px;background:var(--surface2);border-radius:8px;">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px;">Mayor inversi√≥n</div>
        <div style="font-weight:700;color:var(--amber)">${trends.highestSpend.label}: ${fmt(trends.highestSpend.spend)}</div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px;">${trends.highestSpend.days} d√≠as activos</div>
      </div>
      <div style="padding:12px;background:var(--surface2);border-radius:8px;">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px;">Eficiencia de alcance</div>
        <div style="font-weight:700;">${eff.reachRate.toFixed(1)}%</div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px;">Reach / Impresiones</div>
      </div>
      <div style="padding:12px;background:var(--surface2);border-radius:8px;">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px;">Costo por Orden</div>
        <div style="font-weight:700;color:var(--accent)">${fmt(eff.costPerOrder)}</div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px;">Gasto Meta / √ìrdenes</div>
      </div>
      <div style="padding:12px;background:var(--surface2);border-radius:8px;">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px;">Tasa de mensajes</div>
        <div style="font-weight:700;">${eff.messageRate.toFixed(3)}%</div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px;">Mensajes / Alcance</div>
      </div>
    </div>`;
}

// Render client LTV comparison
function renderLTVComparison() {
  const cs = RAW.customer_stats;
  const cohort = getCohortMetrics();
  
  let ltvCard = document.getElementById('ltv-comparison-card');
  if (!ltvCard) {
    ltvCard = document.createElement('div');
    ltvCard.id = 'ltv-comparison-card';
    ltvCard.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:22px;';
    const kpiGrid = document.getElementById('clientes-kpis');
    kpiGrid.parentNode.insertBefore(ltvCard, kpiGrid.nextSibling.nextSibling);
  }
  
  const maxLTV = cs.avg_repeat_ltv;
  ltvCard.innerHTML = `
    <div style="font-size:13px;font-weight:700;margin-bottom:14px;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;">üí≥ Comparativa LTV por Segmento</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;">
      <div>
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="font-size:13px;">Compra √∫nica (165 clientes)</span>
          <span style="font-weight:700;color:var(--amber)">${fmtCLPFull(cs.avg_ltv)}</span>
        </div>
        <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${(cs.avg_ltv/maxLTV*100).toFixed(0)}%;background:var(--amber);"></div></div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px;">${(cs.avg_ltv/maxLTV*100).toFixed(0)}% del LTV m√°ximo</div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="font-size:13px;">Clientes recurrentes (38)</span>
          <span style="font-weight:700;color:var(--teal)">${fmtCLPFull(cs.avg_repeat_ltv)}</span>
        </div>
        <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:100%;background:var(--teal);"></div></div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px;">Valor m√°ximo ¬∑ ${cs.ltv_multiplier}x m√°s que compra √∫nica</div>
      </div>
      <div style="background:var(--surface2);padding:14px;border-radius:8px;">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px;">üìà M√©tricas de Cohorte</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div><div style="font-size:10px;color:var(--text3)">Tasa repetici√≥n</div><div style="font-weight:700;color:var(--teal)">${cohort.repeatRate}%</div></div>
          <div><div style="font-size:10px;color:var(--text3)">Tasa churn</div><div style="font-weight:700;color:var(--red)">${cohort.churnRate}%</div></div>
          <div><div style="font-size:10px;color:var(--text3)">√ìrdenes/cliente</div><div style="font-weight:700;">${cohort.avgOrdersPerCustomer}</div></div>
          <div><div style="font-size:10px;color:var(--text3)">Rev/cliente nuevo</div><div style="font-weight:700;color:var(--accent)">${fmt(parseInt(cohort.revenuePerNewCustomer))}</div></div>
        </div>
      </div>
    </div>`;
}

// Enhance renderClientes to call LTV comparison
const _origRenderClientes = renderClientes;
renderClientes = function() {
  _origRenderClientes();
  renderLTVComparison();
};

// Enhance renderMeta to call insights
const _origRenderMeta = renderMeta;
renderMeta = function() {
  _origRenderMeta();
  renderMetaInsights();
};

// Handle keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.altKey) {
    switch(e.key) {
      case '1': showSection('overview', document.querySelector('nav a:nth-child(1)')); break;
      case '2': showSection('meta', document.querySelector('nav a:nth-child(2)')); break;
      case '3': showSection('ads', document.querySelector('nav a:nth-child(3)')); break;
      case '4': showSection('shopify', document.querySelector('nav a:nth-child(4)')); break;
      case '5': showSection('clientes', document.querySelector('nav a:nth-child(5)')); break;
      case '6': showSection('analytics', document.querySelector('nav a:nth-child(6)')); break;
    }
  }
});

// Smooth scroll to top on section change
const _origShowSection = showSection;
showSection = function(id, el) {
  _origShowSection(id, el);
  document.getElementById('main').scrollTop = 0;
  window.scrollTo(0, 0);
};

// Print / Export page functionality  
function printDashboard() {
  window.print();
}

// Add keyboard shortcut hint to footer
document.addEventListener('DOMContentLoaded', function() {
  const footer = document.getElementById('dashboard-footer');
  if (footer) {
    footer.innerHTML += '<div style="font-size:11px;color:var(--text3)">Alt+1-6: Navegar secciones &nbsp;¬∑&nbsp; Generado: ' + new Date().toLocaleDateString('es-CL', {day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) + '</div>';
  }
});
// ========== END ADDITIONAL FUNCTIONS ==========

</script>
</body>
</html>